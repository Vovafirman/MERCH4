<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="icon" type="image/svg+xml" href="favicoin/fovicoin.svg">
    <link rel="shortcut icon" type="image/svg+xml" href="favicoin/fovicoin.svg">
    <title>Админ панель - Центр Кино™ v2.6 (СИНХРОНИЗАЦИЯ ИСПРАВЛЕНА)</title>
    <!-- Подключить в <head> ПЕРЕД нашими скриптами на всех страницах: admin.html, catalog.html, product.html -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      // ВСТАВЬ СЮДА свои значения:
      const SUPABASE_URL  = "https://YOUR_PROJECT_ID.supabase.co";
      const SUPABASE_ANON = "YOUR_PUBLIC_ANON_KEY";

      window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="init-products.js"></script>
    <script>
        // Инициализация товаров при загрузке страницы
        window.addEventListener('load', function() {
            // Проверяем есть ли товары в localStorage
            const existingProducts = localStorage.getItem('products');
            if (!existingProducts) {
                console.log('Товары не найдены в localStorage, инициализируем...');
                // Если товаров нет, инициализируем их
                if (typeof testProducts !== 'undefined') {
                    localStorage.setItem('products', JSON.stringify(testProducts));
                    console.log('Товары инициализированы:', testProducts.length, 'шт.');
                } else {
                    console.error('testProducts не определены!');
                }
            } else {
                console.log('Товары уже есть в localStorage');
            }
        });

        // Проверка загрузки Chart.js
        window.addEventListener('load', function() {
            if (typeof Chart === 'undefined') {
                console.error('Chart.js не загружен! Попробуем альтернативный CDN...');
                // Попробуем альтернативный CDN
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js';
                script.onload = function() {
                    console.log('Chart.js загружен с альтернативного CDN');
                };
                script.onerror = function() {
                    console.error('Не удалось загрузить Chart.js');
                };
                document.head.appendChild(script);
            } else {
                console.log('Chart.js успешно загружен');
            }
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Local IBM Plex Mono font faces */
        @font-face { font-family: 'IBM Plex Mono'; src: url('шрифт/IBMPlexMono-SemiBold.ttf') format('truetype'); font-weight: 600; font-style: normal; font-display: swap; }

        body {
            font-family: 'IBM Plex Mono', monospace;
            background: #1a1a1a;
            color: #ffffff;
            min-height: 100vh;
        }

        /* Force IBM Plex Mono everywhere */
        html, body, input, button, select, textarea, a, span, div, p, h1, h2, h3, h4, h5, h6 {
            font-family: 'IBM Plex Mono', monospace !important;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .login-section {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #1a1a1a;
        }

        .login-form {
            background: #2a2a2a;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 400px;
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #ffffff;
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #cccccc;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #444;
            border-radius: 5px;
            background: #333;
            color: #ffffff;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #666;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: #000000;
            color: #ffffff;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .login-btn:hover {
            background: #333;
        }

        .error-message {
            color: #ff6b6b;
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
        }

        .admin-panel {
            display: none;
            min-height: 100vh;
        }

        .admin-header {
            background: #000000;
            padding: 20px 0;
            margin-bottom: 40px;
        }

        .admin-header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .admin-title {
            font-size: 24px;
            font-weight: bold;
        }

        .logout-btn {
            background: #ff6b6b;
            color: #ffffff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: #ff5252;
        }

        .admin-tabs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .tab-button {
            background: #2a2a2a;
            border: 2px solid #444;
            border-radius: 10px;
            padding: 30px 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #ffffff;
            position: relative;
        }

        .tab-button .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4444;
            color: #ffffff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .tab-button:hover {
            background: #333;
            border-color: #666;
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
            margin-top: 40px;
        }

        .tab-content.active {
            display: block;
        }

        .tab-content h3 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .content-placeholder {
            text-align: center;
            color: #888;
            font-size: 16px;
            padding: 40px;
            background: #2a2a2a;
            border-radius: 10px;
        }

        /* Стили для статистики */
        .chart-controls {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            color: #cccccc;
            font-size: 14px;
            font-weight: bold;
        }

        .control-group select {
            padding: 8px 12px;
            border: 1px solid #444;
            border-radius: 5px;
            background: #333;
            color: #ffffff;
            font-size: 14px;
            cursor: pointer;
        }

        .control-group select:focus {
            outline: none;
            border-color: #666;
        }

        .category-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .category-checkboxes label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #cccccc;
            font-size: 14px;
            font-weight: normal;
            cursor: pointer;
        }

        .category-checkboxes input[type="checkbox"] {
            width: auto;
            margin: 0;
            cursor: pointer;
        }

        .chart-container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .export-section {
            text-align: center;
        }

        .export-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: #ffffff;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .export-btn:hover {
            background: linear-gradient(135deg, #45a049, #4CAF50);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .export-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(76, 175, 80, 0.3);
        }

        /* Стили для управления товарами */
        .products-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .add-product-btn, .refresh-products-btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: #ffffff;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .add-product-btn:hover, .refresh-products-btn:hover {
            background: linear-gradient(135deg, #0056b3, #007bff);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        .product-form-container {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #444;
        }

        .product-form h4 {
            color: #ffffff;
            margin-bottom: 20px;
            font-size: 20px;
            text-align: center;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #cccccc;
            font-size: 14px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #444;
            border-radius: 5px;
            background: #333;
            color: #ffffff;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .form-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .save-product-btn, .cancel-product-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .save-product-btn {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: #ffffff;
        }

        .save-product-btn:hover {
            background: linear-gradient(135deg, #1e7e34, #28a745);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .cancel-product-btn {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: #ffffff;
        }

        .cancel-product-btn:hover {
            background: linear-gradient(135deg, #c82333, #dc3545);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .products-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .product-item {
            background: #333;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #007bff;
            transition: transform 0.3s ease;
        }

        .product-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .product-info h4 {
            color: #ffffff;
            margin-bottom: 5px;
            font-size: 16px;
        }

        .product-info p {
            color: #cccccc;
            margin: 3px 0;
            font-size: 14px;
        }

        .product-actions {
            display: flex;
            gap: 8px;
        }

        .edit-product-btn, .delete-product-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .edit-product-btn {
            background: #ffc107;
            color: #000;
        }

        .edit-product-btn:hover {
            background: #e0a800;
            transform: translateY(-1px);
        }

        .delete-product-btn {
            background: #dc3545;
            color: #ffffff;
        }

        .delete-product-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .product-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #444;
        }

        .product-details h5 {
            color: #ffffff;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .product-details p {
            color: #cccccc;
            margin: 5px 0;
            font-size: 13px;
        }

        .product-images {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .product-image-preview {
            width: 100px;
            height: 100px;
            background: #444;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #999;
            border: 1px solid #555;
            overflow: hidden;
        }

        .product-image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }

        /* Стили для кнопок выбора размеров и цветов */
        .options-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }

        .option-btn {
            padding: 8px 16px;
            border: 1px solid #555;
            background: #333;
            color: #ffffff;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            min-width: 60px;
            text-align: center;
        }

        .option-btn:hover {
            background: #555;
            border-color: #777;
        }

        .option-btn.selected {
            background: #007bff;
            border-color: #007bff;
            color: #ffffff;
        }

        /* Стили для загрузки изображений */
        .image-upload-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 15px;
        }

        .image-upload-block {
            border: 2px dashed #555;
            border-radius: 10px;
            padding: 15px;
            background: #2a2a2a;
        }

        .image-upload-block label {
            display: block;
            margin-bottom: 10px;
            color: #cccccc;
            font-size: 14px;
            font-weight: bold;
        }

        .image-upload-area {
            position: relative;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #444;
            border-radius: 5px;
            background: #333;
        }

        .image-upload-area:hover {
            background: #444;
            border-color: #666;
        }

        .upload-placeholder {
            text-align: center;
            color: #cccccc;
        }

        .upload-icon {
            font-size: 24px;
            display: block;
            margin-bottom: 5px;
        }

        .image-preview {
            margin-top: 10px;
            min-height: 80px;
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid #555;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-preview img {
            width: 100%;
            height: 80px;
            object-fit: cover;
        }

        .image-preview .remove-image {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-preview .remove-image:hover {
            background: #c82333;
        }

        /* Стили для заказов */
        .orders-container {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 20px;
        }

        .orders-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: #333;
            border: 1px solid #555;
            color: #ffffff;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background: #444;
            border-color: #666;
        }

        .filter-btn.active {
            background: #007bff;
            border-color: #007bff;
        }

        .orders-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .order-item {
            background: #333;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #007bff;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .order-info h4 {
            color: #ffffff;
            margin-bottom: 5px;
            font-size: 18px;
        }

        .order-info p {
            color: #cccccc;
            margin: 3px 0;
            font-size: 14px;
        }

        .order-status-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }

        .status-select {
            padding: 8px 12px;
            border: 1px solid #444;
            border-radius: 5px;
            background: #333;
            color: #ffffff;
            font-size: 14px;
            cursor: pointer;
        }

        .status-select:focus {
            outline: none;
            border-color: #666;
        }

        .tracking-section {
            display: none;
            margin-top: 10px;
            padding: 15px;
            background: #444;
            border-radius: 5px;
            position: relative;
        }

        .tracking-section.show {
            display: block;
        }

        .tracking-section.collapsed {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .tracking-inputs {
            width: 100%;
        }

        .expand-btn {
            background: #666;
            color: #ffffff;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .expand-btn:hover {
            background: #888;
        }

        .user-profile-info {
            margin-top: 15px;
            padding: 15px;
            background: #444;
            border-radius: 5px;
        }

        .user-profile-info h5 {
            color: #ffffff;
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
        }

        .user-profile-info p {
            color: #cccccc;
            margin: 5px 0;
            font-size: 12px;
        }

        .tracking-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #555;
            border-radius: 5px;
            background: #333;
            color: #ffffff;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .tracking-input:focus {
            outline: none;
            border-color: #666;
        }

        .confirm-btn {
            background: #28a745;
            color: #ffffff;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .confirm-btn:hover {
            background: #218838;
        }

        .expand-btn {
            background: #007bff;
            color: #ffffff;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            transition: background 0.3s;
        }

        .expand-btn:hover {
            background: #0056b3;
        }

        .tracking-section.collapsed .tracking-inputs {
            display: none;
        }

        .tracking-section.show .expand-btn {
            display: none;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
            padding: 20px 0;
        }

        .pagination-btn {
            padding: 8px 12px;
            background: #444;
            color: #ffffff;
            border: 1px solid #666;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .pagination-btn:hover {
            background: #666;
        }

        .pagination-btn.active {
            background: #007bff;
            border-color: #007bff;
        }

        .pagination-btn:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }

        /* ===== СТИЛИ ДЛЯ ОТЧЕТОВ (ГЛОБАЛЬНЫЕ) ===== */
        .reports-container {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 20px;
        }

        .reports-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .reports-export {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            width: 100%;
            clear: both;
        }

        .export-btn {
            background: #28a745;
            border: 1px solid #28a745;
            color: #ffffff;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .export-btn:hover {
            background: #218838;
            border-color: #218838;
        }

        .reports-table-container {
            background: #333;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 20px;
            max-width: 100%;
            border: 3px solid #555555;
            padding: 10px;
        }

        .reports-table {
            width: 100%;
            min-width: 800px;
            border-collapse: collapse;
            font-size: 14px;
            border: 2px solid #666666;
            table-layout: auto;
        }

        .reports-table th {
            background: #444;
            color: #ffffff;
            padding: 14px 14px;
            text-align: left;
            font-weight: 600;
            border: 2px solid #888888;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .reports-table th:last-child {}

        .reports-table td {
            padding: 12px 14px;
            border: 2px solid #666666;
            color: #e0e0e0;
            vertical-align: top;
            background: #2b2b2b;
            word-wrap: break-word;
            white-space: normal;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .reports-table td:last-child {
            border-right: none;
        }

        .reports-table tbody tr:hover {
            background: #3a3a3a;
        }

        .reports-table tbody tr:nth-child(odd) td { 
            background: #2b2b2b; 
            border: 2px solid #666666;
        }
        .reports-table tbody tr:nth-child(even) td { 
            background: #262626; 
            border: 2px solid #666666;
        }
        .reports-table tbody tr:hover td { 
            background: #333; 
            border: 2px solid #888888;
        }

        /* Выравнивание чисел справа */
        .reports-table td.num, .reports-table th.num { text-align: right; white-space: nowrap; }
        .reports-table td.small { color: #a0a0a0; font-size: 12px; }

        /* Стили для промокодов */
        .promocodes-container, .discounts-container {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .promocodes-filters, .discounts-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .promocodes-actions, .discounts-actions {
            margin-bottom: 20px;
        }

        .add-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.3s;
        }

        .add-btn:hover {
            background: #45a049;
        }



        .promocodes-table-container, .discounts-table-container {
            overflow-x: auto;
            background: #333;
            border-radius: 8px;
            padding: 10px;
        }

        .promocodes-table, .discounts-table {
            width: 100%;
            border-collapse: collapse;
            background: #333;
            color: #ffffff;
            font-size: 14px;
        }

        .promocodes-table th, .discounts-table th {
            background: #444;
            color: #ffffff;
            padding: 12px 8px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #555;
            font-size: 14px;
        }

        .promocodes-table td, .discounts-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #444;
            vertical-align: middle;
        }

        .promocodes-table tbody tr:nth-child(even) td,
        .discounts-table tbody tr:nth-child(even) td {
            background: #3a3a3a;
        }

        .promocodes-table tbody tr:hover td,
        .discounts-table tbody tr:hover td {
            background: #555;
        }

        .status-active {
            color: #4CAF50;
            font-weight: bold;
        }

        .status-expired {
            color: #f44336;
            font-weight: bold;
        }

        .action-btn {
            background: #666;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin: 2px;
            transition: background 0.3s;
        }

        .action-btn:hover {
            background: #888;
        }

        .action-btn.delete {
            background: #f44336;
        }

        .action-btn.delete:hover {
            background: #d32f2f;
        }

        .action-btn.edit {
            background: #2196F3;
        }

        .action-btn.edit:hover {
            background: #1976D2;
        }

        .reports-summary {
            background: #444;
            border-radius: 8px;
            padding: 20px;
            color: #ffffff;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .reports-summary h4 {
            margin-bottom: 15px;
            color: #ffffff;
            font-size: 18px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .summary-stat {
            background: #555;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }

        .summary-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
        }

        .summary-stat-label {
            font-size: 14px;
            color: #cccccc;
        }

        .order-items {
            margin-top: 15px;
        }

        .order-item-detail {
            display: flex;
            gap: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #444;
        }

        .order-item-detail:last-child {
            border-bottom: none;
        }

        .item-image {
            width: 60px;
            height: 80px;
            background: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            border-radius: 5px;
        }

        .item-number {
            font-size: 18px;
            color: #ffffff;
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            color: #ffffff;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .item-info {
            color: #cccccc;
            font-size: 14px;
            margin: 2px 0;
        }

        @media (max-width: 768px) {
            .admin-tabs {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .tab-button {
                padding: 20px 15px;
                font-size: 16px;
            }

            .login-form {
                margin: 20px;
                padding: 30px 20px;
            }

            .category-checkboxes {
                flex-direction: column;
                gap: 10px;
            }

            .chart-container {
                min-height: 300px;
                padding: 15px;
            }

            .chart-controls {
                padding: 15px;
            }

            .order-header {
                flex-direction: column;
                gap: 15px;
            }

            .order-status-controls {
                align-items: stretch;
            }

            .orders-filters {
                flex-direction: column;
                gap: 8px;
            }

            .filter-btn {
                width: 100%;
                text-align: center;
            }

            /* Стили для системы обращений - точные копии стилей заказов */
            .appeal-count {
                background: #ff4444;
                color: white;
                border-radius: 50%;
                padding: 2px 6px;
                font-size: 12px;
                margin-left: 8px;
                min-width: 20px;
                display: inline-block;
                text-align: center;
            }

            .appeal-item {
                background: #333;
                border-radius: 8px;
                padding: 20px;
                border-left: 4px solid #007bff;
            }

            .appeal-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 15px;
            }

            .appeal-info h4 {
                color: #ffffff;
                margin-bottom: 5px;
                font-size: 18px;
            }

            .appeal-info p {
                color: #cccccc;
                margin: 3px 0;
                font-size: 14px;
            }

            .appeal-status-controls {
                display: flex;
                flex-direction: column;
                gap: 10px;
                align-items: flex-end;
            }

            .appeal-message {
                background: #444;
                border: 1px solid #555;
                border-radius: 5px;
                padding: 15px;
                color: #cccccc;
                font-size: 14px;
                line-height: 1.5;
                margin-top: 15px;
            }

            .no-appeals {
                text-align: center;
                color: #888;
                font-size: 16px;
                padding: 40px;
            }

            /* Стили для отчетов */
            .reports-container {
                background: #2a2a2a;
                border-radius: 10px;
                padding: 20px;
            }

            .reports-filters {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
                flex-wrap: wrap;
                align-items: center;
            }

            .reports-export {
                display: flex;
                justify-content: flex-end;
                margin-top: 20px;
                width: 100%;
                clear: both; /* чтобы не наползало на сводку, если в ней есть плавающие блоки */
            }

            .export-btn {
                background: #28a745;
                border: 1px solid #28a745;
                color: #ffffff;
                padding: 12px 24px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 16px;
                transition: all 0.3s ease;
                font-weight: 600;
            }

            .export-btn:hover {
                background: #218838;
                border-color: #218838;
            }

            .reports-table-container {
                background: #333;
                border-radius: 8px;
                overflow-x: auto;
                margin-bottom: 20px;
                max-width: 100%;
                border: 3px solid #555555;
                padding: 10px;
            }

            .reports-table {
                width: 100%;
                min-width: 800px;
                border-collapse: collapse;
                font-size: 14px;
                border: 2px solid #666666;
                table-layout: auto;
            }

            .reports-table th {
                background: #444;
                color: #ffffff;
                padding: 14px 14px;
                text-align: left;
                font-weight: 600;
                border: 2px solid #888888;
                white-space: nowrap;
                position: sticky;
                top: 0;
                z-index: 10;
            }

            .reports-table th:last-child {}

            .reports-table td {
                padding: 12px 14px;
                border: 2px solid #666666;
                color: #e0e0e0;
                vertical-align: top;
                background: #2b2b2b;
                word-wrap: break-word;
                white-space: normal;
                max-width: 200px;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .reports-table td:last-child {
                border-right: none;
            }

            .reports-table tbody tr:hover {
                background: #3a3a3a;
            }

            .reports-table tbody tr:nth-child(odd) td { 
                background: #2b2b2b; 
                border: 2px solid #666666;
            }
            .reports-table tbody tr:nth-child(even) td { 
                background: #262626; 
                border: 2px solid #666666;
            }
            .reports-table tbody tr:hover td { 
                background: #333; 
                border: 2px solid #888888;
            }

            /* Выравнивание чисел справа */
            .reports-table td.num, .reports-table th.num { text-align: right; white-space: nowrap; }
            .reports-table td.small { color: #a0a0a0; font-size: 12px; }

            .reports-summary {
                background: #444;
                border-radius: 8px;
                padding: 20px;
                color: #ffffff;
                margin-top: 20px;
                margin-bottom: 20px; /* чтобы кнопка выгрузки не перекрывала сводку */
            }

            .reports-summary h4 {
                margin-bottom: 15px;
                color: #ffffff;
                font-size: 18px;
            }

            .summary-stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
            }

            .summary-stat {
                background: #555;
                padding: 15px;
                border-radius: 5px;
                text-align: center;
            }

            .summary-stat-value {
                font-size: 24px;
                font-weight: bold;
                color: #4CAF50;
                margin-bottom: 5px;
            }

            .summary-stat-label {
                font-size: 14px;
                color: #cccccc;
            }
        }
    </style>
</head>
<body>
    <!-- Секция входа -->
    <div class="login-section" id="loginSection">
        <div class="login-form">
            <h2>Вход в админ панель</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Логин:</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Пароль:</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="login-btn">Войти</button>
            </form>
            <div class="error-message" id="errorMessage"></div>
            <div style="margin-top: 20px; text-align: center;">
                <button type="button" onclick="resetAuth()" style="background: #ff4444; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 12px; margin-right: 10px;">
                    🔄 Сбросить данные входа
                </button>
                <button type="button" onclick="forceLogin()" style="background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 12px;">
                    🚀 Принудительный вход
                </button>
            </div>
        </div>
    </div>

    <!-- Админ панель -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-header">
            <div class="admin-header-content">
                <div class="admin-title">Админ панель - Центр Кино™</div>
                <button class="logout-btn" onclick="logout()">Выйти</button>
            </div>
        </div>

        <div class="admin-container">
            <!-- Вкладки -->
            <div class="admin-tabs">
                <div class="tab-button" onclick="showTab('statistics')">
                    Статистика
                </div>
                <div class="tab-button" onclick="showTab('orders')" id="ordersTab">
                    Заказы
                    <div class="notification-badge" id="ordersNotification" style="display: none;">0</div>
                </div>
                <div class="tab-button" onclick="showTab('products')">
                    Товары
                </div>
                <div class="tab-button" onclick="showTab('content')">
                    Контент
                </div>
                <div class="tab-button" onclick="showTab('appeals')" id="appealsTab">
                    <span>Обращения</span>
                    <span class="notification-badge" id="appealsNotification" style="display: none;">0</span>
                </div>
                <div class="tab-button" onclick="showTab('reports')">
                    Отчеты
                </div>
                <div class="tab-button" onclick="showTab('promocodes')">
                    Промокоды
                </div>
                <div class="tab-button" onclick="showTab('discounts')">
                    Скидки
                </div>
            </div>

            <!-- Контент вкладок -->
            <div class="tab-content active" id="statistics">
                <h3>Статистика</h3>
                
                <!-- Контролы для графика -->
                <div class="chart-controls">
                    <div class="control-group">
                        <label>Период:</label>
                        <select id="periodSelect" onchange="updateChart()">
                            <option value="1">1 день</option>
                            <option value="3">3 дня</option>
                            <option value="7">7 дней</option>
                            <option value="30" selected>Месяц</option>
                            <option value="90">3 месяца</option>
                            <option value="180">6 месяцев</option>
                            <option value="365">12 месяцев</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label>Категории:</label>
                        <div class="category-checkboxes">
                            <label><input type="checkbox" value="visits" checked onchange="updateChart()"> Посещения сайта</label>
                            <label><input type="checkbox" value="orders" onchange="updateChart()"> Оформленные заказы</label>
                            <label><input type="checkbox" value="catalog" onchange="updateChart()"> Переход в каталог</label>
                            <label><input type="checkbox" value="newArrivals" onchange="updateChart()"> Переход в новые поступления</label>
                            <label><input type="checkbox" value="kinoshlep" onchange="updateChart()"> Переход на ссылку: КИНОШЛЕП</label>
                            <label><input type="checkbox" value="registrations" onchange="updateChart()"> Зарегистрировавшиеся пользователи</label>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <button onclick="forceInitChart()" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            🔄 Принудительно инициализировать график
                        </button>
                    </div>
                </div>

                <!-- График -->
                <div class="chart-container">
                    <canvas id="statisticsChart"></canvas>
                </div>

                <!-- Кнопка выгрузки -->
                <div class="export-section">
                    <button class="export-btn" onclick="exportStatistics()">
                        📊 Выгрузить статистику (Excel)
                    </button>
                    <button class="export-btn" onclick="exportStatisticsHTML()" style="margin-left: 10px;">
                        🖨️ Выгрузить HTML отчёт
                    </button>
                </div>
            </div>

            <div class="tab-content" id="orders">
                <h3>Заказы</h3>
                <div class="orders-container">
                    <!-- Фильтры заказов -->
                    <div class="orders-filters">
                        <button class="filter-btn active" data-filter="all" onclick="filterOrders('all')">
                            Все заказы
                        </button>
                        <button class="filter-btn" data-filter="В сборке" onclick="filterOrders('В сборке')">
                            Заказы в сборке
                        </button>
                        <button class="filter-btn" data-filter="Отправлен" onclick="filterOrders('Отправлен')">
                            Отправленные заказы
                        </button>
                        <button class="filter-btn" data-filter="Доставлен" onclick="filterOrders('Доставлен')">
                            Доставленные заказы
                        </button>
                    </div>
                    <div class="orders-list" id="ordersList">
                        <!-- Заказы будут загружены здесь -->
                    </div>
                    <div class="pagination" id="ordersPagination">
                        <!-- Пагинация будет загружена здесь -->
                    </div>
                </div>
            </div>

            <div class="tab-content" id="products">
                <h3>Управление товарами</h3>
                
                <!-- Кнопки управления -->
                <div class="products-controls">
                    <button class="add-product-btn" onclick="showAddProductForm()">
                        ➕ Добавить новый товар
                    </button>
                </div>

                <!-- Форма добавления/редактирования товара -->
                <div class="product-form-container" id="productFormContainer" style="display: none;">
                    <div class="product-form">
                        <h4 id="productFormTitle">Добавить новый товар</h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>ID товара:</label>
                                <input type="number" id="productId" placeholder="Уникальный ID">
                            </div>
                            <div class="form-group">
                                <label>Артикул:</label>
                                <input type="text" id="productArticle" placeholder="Артикул товара">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Название товара:</label>
                            <input type="text" id="productName" placeholder="Название товара">
                        </div>

                        <div class="form-group">
                            <label>Описание:</label>
                            <textarea id="productDescription" placeholder="Описание товара" rows="3"></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Цена (₽):</label>
                                <input type="number" id="productPrice" placeholder="Цена">
                            </div>
                                                    <div class="form-group">
                            <label>Категория (можно выбрать несколько):</label>
                            <div class="category-checkboxes">
                                <label><input type="checkbox" value="мужская"> Мужская</label>
                                <label><input type="checkbox" value="женская"> Женская</label>
                                <label><input type="checkbox" value="настольные игры"> Настольные игры</label>
                                <label><input type="checkbox" value="аксессуары"> Аксессуары</label>
                            </div>
                            <input type="hidden" id="productCategory" value="">
                        </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Материал:</label>
                                <input type="text" id="productMaterial" placeholder="Материал">
                            </div>
                            <div class="form-group">
                                <label>Сезон:</label>
                                <input type="text" id="productSeason" placeholder="Сезон">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Стиль:</label>
                                <input type="text" id="productStyle" placeholder="Стиль">
                            </div>
                            <div class="form-group">
                                <label>Страна производитель:</label>
                                <input type="text" id="productCountry" placeholder="Страна">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Размеры:</label>
                            <div class="options-buttons" id="sizesContainer">
                                <button type="button" class="option-btn" data-value="ONESIZE">ONESIZE</button>
                                <button type="button" class="option-btn" data-value="XS">XS</button>
                                <button type="button" class="option-btn" data-value="S">S</button>
                                <button type="button" class="option-btn" data-value="M">M</button>
                                <button type="button" class="option-btn" data-value="L">L</button>
                                <button type="button" class="option-btn" data-value="XL">XL</button>
                                <button type="button" class="option-btn" data-value="XXL">XXL</button>
                            </div>
                            <input type="hidden" id="productSizes" value="">
                        </div>

                        <div class="form-group">
                            <label>Цвета:</label>
                            <div class="options-buttons" id="colorsContainer">
                                <button type="button" class="option-btn" data-value="Черный">Черный</button>
                                <button type="button" class="option-btn" data-value="Белый">Белый</button>
                                <button type="button" class="option-btn" data-value="Молочный">Молочный</button>
                                <button type="button" class="option-btn" data-value="Серый">Серый</button>
                                <button type="button" class="option-btn" data-value="Красный">Красный</button>
                                <button type="button" class="option-btn" data-value="Зеленый">Зеленый</button>
                                <button type="button" class="option-btn" data-value="Желтый">Желтый</button>
                                <button type="button" class="option-btn" data-value="Фиолетовый">Фиолетовый</button>
                                <button type="button" class="option-btn" data-value="Бежевый">Бежевый</button>
                                <button type="button" class="option-btn" data-value="Розовый">Розовый</button>
                            </div>
                            <input type="hidden" id="productColors" value="">
                        </div>

                        <div class="form-group">
                            <label>Изображения товара (4 фото):</label>
                            <div class="image-upload-grid">
                                <div class="image-upload-block">
                                    <label>Фото 1:</label>
                                    <div class="image-upload-area" id="imageUploadArea1">
                                        <input type="file" id="imageUpload1" accept="image/*" style="display: none;">
                                        <div class="upload-placeholder">
                                            <span class="upload-icon">📷</span>
                                            <p>Фото 1</p>
                                            <p style="font-size: 12px; color: #666; margin-top: 5px;">Рекомендуемый размер: 350×500px</p>
                                        </div>
                                    </div>
                                    <div class="image-preview" id="imagePreview1"></div>
                                </div>
                                <div class="image-upload-block">
                                    <label>Фото 2:</label>
                                    <div class="image-upload-area" id="imageUploadArea2">
                                        <input type="file" id="imageUpload2" accept="image/*" style="display: none;">
                                        <div class="upload-placeholder">
                                            <span class="upload-icon">📷</span>
                                            <p>Фото 2</p>
                                            <p style="font-size: 12px; color: #666; margin-top: 5px;">Рекомендуемый размер: 350×500px</p>
                                        </div>
                                    </div>
                                    <div class="image-preview" id="imagePreview2"></div>
                                </div>
                                <div class="image-upload-block">
                                    <label>Фото 3:</label>
                                    <div class="image-upload-area" id="imageUploadArea3">
                                        <input type="file" id="imageUpload3" accept="image/*" style="display: none;">
                                        <div class="upload-placeholder">
                                            <span class="upload-icon">📷</span>
                                            <p>Фото 3</p>
                                            <p style="font-size: 12px; color: #666; margin-top: 5px;">Рекомендуемый размер: 350×500px</p>
                                        </div>
                                    </div>
                                    <div class="image-preview" id="imagePreview3"></div>
                                </div>
                                <div class="image-upload-block">
                                    <label>Фото 4:</label>
                                    <div class="image-upload-area" id="imageUploadArea4">
                                        <input type="file" id="imageUpload4" accept="image/*" style="display: none;">
                                        <div class="upload-placeholder">
                                            <span class="upload-icon">📷</span>
                                            <p>Фото 4</p>
                                            <p style="font-size: 12px; color: #666; margin-top: 5px;">Рекомендуемый размер: 350×500px</p>
                                        </div>
                                    </div>
                                    <div class="image-preview" id="imagePreview4"></div>
                                </div>
                            </div>
                            <input type="hidden" id="productImages" value="">
                        </div>

                        <div class="form-group">
                            <label>Рекомендации по стирке:</label>
                            <textarea id="productWashing" placeholder="Рекомендации по стирке" rows="2"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Состав:</label>
                            <textarea id="productComposition" placeholder="Состав материала" rows="2"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Уход:</label>
                            <textarea id="productCare" placeholder="Рекомендации по уходу" rows="2"></textarea>
                        </div>

                        <div class="form-buttons">
                            <button class="save-product-btn" onclick="saveProduct()">
                                💾 Сохранить товар
                            </button>
                            <button class="cancel-product-btn" onclick="hideProductForm()">
                                ❌ Отмена
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Список товаров -->
                <div class="products-list" id="productsList">
                    <!-- Товары будут загружены здесь -->
                </div>
            </div>

            <div class="tab-content" id="content">
                <h3>Управление контентом</h3>
                <div class="content-container">
                    <div class="content-header">
                        <!-- Заголовок удален -->
                    </div>
                    
                    <!-- Фильтры контента -->
                    <div class="content-filters" style="display: flex !important; gap: 10px !important; margin-bottom: 100px !important; flex-wrap: nowrap !important; align-items: center !important; justify-content: center !important; overflow-x: auto !important; padding: 10px 0 !important;">
                        <button class="filter-btn active" data-filter="main" onclick="filterContent('main')" style="background: #2a2a2a !important; border: 2px solid #444 !important; color: #ffffff !important; padding: 12px 15px !important; border-radius: 8px !important; cursor: pointer !important; font-size: 12px !important; font-weight: bold !important; transition: all 0.3s ease !important; text-transform: uppercase !important; letter-spacing: 0.5px !important; min-width: 120px !important; text-align: center !important; white-space: nowrap !important; flex-shrink: 0 !important;">
                            ГЛАВНАЯ СТРАНИЦА
                        </button>
                        <button class="filter-btn" data-filter="new-arrivals" onclick="filterContent('new-arrivals')" style="background: #2a2a2a !important; border: 2px solid #444 !important; color: #ffffff !important; padding: 12px 15px !important; border-radius: 8px !important; cursor: pointer !important; font-size: 12px !important; font-weight: bold !important; transition: all 0.3s ease !important; text-transform: uppercase !important; letter-spacing: 0.5px !important; min-width: 120px !important; text-align: center !important; white-space: nowrap !important; flex-shrink: 0 !important;">
                            НОВЫЕ ПОСТУПЛЕНИЯ
                        </button>
                        <button class="filter-btn" data-filter="catalog" onclick="filterContent('catalog')" style="background: #2a2a2a !important; border: 2px solid #444 !important; color: #ffffff !important; padding: 12px 15px !important; border-radius: 8px !important; cursor: pointer !important; font-size: 12px !important; font-weight: bold !important; transition: all 0.3s ease !important; text-transform: uppercase !important; letter-spacing: 0.5px !important; min-width: 120px !important; text-align: center !important; white-space: nowrap !important; flex-shrink: 0 !important;">
                            КАТАЛОГ
                        </button>
                        <button class="filter-btn" data-filter="about" onclick="filterContent('about')" style="background: #2a2a2a !important; border: 2px solid #444 !important; color: #ffffff !important; padding: 12px 15px !important; border-radius: 8px !important; cursor: pointer !important; font-size: 12px !important; font-weight: bold !important; transition: all 0.3s ease !important; text-transform: uppercase !important; letter-spacing: 0.5px !important; min-width: 120px !important; text-align: center !important; white-space: nowrap !important; flex-shrink: 0 !important;">
                            О НАС
                        </button>
                        <button class="filter-btn" data-filter="help" onclick="filterContent('help')" style="background: #2a2a2a !important; border: 2px solid #444 !important; color: #ffffff !important; padding: 12px 15px !important; border-radius: 8px !important; cursor: pointer !important; font-size: 12px !important; font-weight: bold !important; transition: all 0.3s ease !important; text-transform: uppercase !important; letter-spacing: 0.5px !important; min-width: 120px !important; text-align: center !important; white-space: nowrap !important; flex-shrink: 0 !important;">
                            ПОМОЩЬ
                        </button>
                        <button class="filter-btn" data-filter="transitions" onclick="filterContent('transitions')" style="background: #2a2a2a !important; border: 2px solid #444 !important; color: #ffffff !important; padding: 12px 15px !important; border-radius: 8px !important; cursor: pointer !important; font-size: 12px !important; font-weight: bold !important; transition: all 0.3s ease !important; text-transform: uppercase !important; letter-spacing: 0.5px !important; min-width: 120px !important; text-align: center !important; white-space: nowrap !important; flex-shrink: 0 !important;">
                            ПЕРЕХОДЫ
                        </button>
                    </div>
                    
                    <!-- Контент для главной страницы -->
                    <div class="content-section" id="mainContent" style="display: block;">
                        <div class="content-buttons">
                            <button class="content-btn" onclick="openContentModal('main', 'banner1')" style="background: #2a2a2a !important; color: #ffffff !important; border: 2px solid #444 !important; padding: 30px 20px !important; border-radius: 10px !important; cursor: pointer !important; font-size: 18px !important; font-weight: bold !important; transition: all 0.3s ease !important; text-transform: uppercase !important; letter-spacing: 1px !important; min-height: 80px !important; display: flex !important; align-items: center !important; justify-content: center !important; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important; width: 100% !important; margin-bottom: 15px !important;">
                                БАНЕР 1
                            </button>
                            <button class="content-btn" onclick="openContentModal('main', 'banner2')" style="background: #2a2a2a !important; color: #ffffff !important; border: 2px solid #444 !important; padding: 30px 20px !important; border-radius: 10px !important; cursor: pointer !important; font-size: 18px !important; font-weight: bold !important; transition: all 0.3s ease !important; text-transform: uppercase !important; letter-spacing: 1px !important; min-height: 80px !important; display: flex !important; align-items: center !important; justify-content: center !important; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important; width: 100% !important; margin-bottom: 15px !important;">
                                БАНЕР 2
                            </button>
                            <button class="content-btn" onclick="openContentModal('main', 'banner3')" style="background: #2a2a2a !important; color: #ffffff !important; border: 2px solid #444 !important; padding: 30px 20px !important; border-radius: 10px !important; cursor: pointer !important; font-size: 18px !important; font-weight: bold !important; transition: all 0.3s ease !important; text-transform: uppercase !important; letter-spacing: 1px !important; min-height: 80px !important; display: flex !important; align-items: center !important; justify-content: center !important; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important; width: 100% !important; margin-bottom: 15px !important;">
                                БАНЕР 3
                            </button>
                            <button class="content-btn" onclick="openContentModal('main', 'banner4')" style="background: #2a2a2a !important; color: #ffffff !important; border: 2px solid #444 !important; padding: 30px 20px !important; border-radius: 10px !important; cursor: pointer !important; font-size: 18px !important; font-weight: bold !important; transition: all 0.3s ease !important; text-transform: uppercase !important; letter-spacing: 1px !important; min-height: 80px !important; display: flex !important; align-items: center !important; justify-content: center !important; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important; width: 100% !important; margin-bottom: 15px !important;">
                                БАНЕР 4 НИЖНИЙ
                            </button>
                        </div>
                    </div>

                    <!-- Контент для новых поступлений -->
                    <div class="content-section" id="new-arrivalsContent" style="display: none;">
                        <div class="content-buttons">
                            <button class="content-btn" onclick="openContentModal('new-arrivals', 'product1')" style="background: #2a2a2a !important; color: #ffffff !important; border: 2px solid #444 !important; padding: 30px 20px !important; border-radius: 10px !important; cursor: pointer !important; font-size: 18px !important; font-weight: bold !important; transition: all 0.3s ease !important; text-transform: uppercase !important; letter-spacing: 1px !important; min-height: 80px !important; display: flex !important; align-items: center !important; justify-content: center !important; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important; width: 100% !important; margin-bottom: 15px !important;">
                                ТОВАР 1
                            </button>
                            <button class="content-btn" onclick="openContentModal('new-arrivals', 'product2')" style="background: #2a2a2a !important; color: #ffffff !important; border: 2px solid #444 !important; padding: 30px 20px !important; border-radius: 10px !important; cursor: pointer !important; font-size: 18px !important; font-weight: bold !important; transition: all 0.3s ease !important; text-transform: uppercase !important; letter-spacing: 1px !important; min-height: 80px !important; display: flex !important; align-items: center !important; justify-content: center !important; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important; width: 100% !important; margin-bottom: 15px !important;">
                                ТОВАР 2
                            </button>
                            <button class="content-btn" onclick="openContentModal('new-arrivals', 'product3')" style="background: #2a2a2a !important; color: #ffffff !important; border: 2px solid #444 !important; padding: 30px 20px !important; border-radius: 10px !important; cursor: pointer !important; font-size: 18px !important; font-weight: bold !important; transition: all 0.3s ease !important; text-transform: uppercase !important; letter-spacing: 1px !important; min-height: 80px !important; display: flex !important; align-items: center !important; justify-content: center !important; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important; width: 100% !important; margin-bottom: 15px !important;">
                                ТОВАР 3
                            </button>
                            <button class="content-btn" onclick="openContentModal('new-arrivals', 'product4')" style="background: #2a2a2a !important; color: #ffffff !important; border: 2px solid #444 !important; padding: 30px 20px !important; border-radius: 10px !important; cursor: pointer !important; font-size: 18px !important; font-weight: bold !important; transition: all 0.3s ease !important; text-transform: uppercase !important; letter-spacing: 1px !important; min-height: 80px !important; display: flex !important; align-items: center !important; justify-content: center !important; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important; width: 100% !important; margin-bottom: 15px !important;">
                                ТОВАР 4
                            </button>
                        </div>
                    </div>

                    <!-- Контент для каталога -->
                    <div class="content-section" id="catalogContent" style="display: none;">
                        <div class="content-buttons">
                            <button class="content-btn" onclick="openContentModal('catalog', 'hero')" style="background: #2a2a2a !important; color: #ffffff !important; border: 2px solid #444 !important; padding: 30px 20px !important; border-radius: 10px !important; cursor: pointer !important; font-size: 18px !important; font-weight: bold !important; transition: all 0.3s ease !important; text-transform: uppercase !important; letter-spacing: 1px !important; min-height: 80px !important; display: flex !important; align-items: center !important; justify-content: center !important; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important; width: 100% !important; margin-bottom: 15px !important;">
                                БАНЕР КАТАЛОГА
                            </button>
                        </div>
                    </div>

                    <!-- Контент для о нас -->
                    <div class="content-section" id="aboutContent" style="display: none;">
                        <div class="content-buttons">
                            <button class="content-btn" onclick="openContentModal('about', 'hero')" style="background: #2a2a2a !important; color: #ffffff !important; border: 2px solid #444 !important; padding: 30px 20px !important; border-radius: 10px !important; cursor: pointer !important; font-size: 18px !important; font-weight: bold !important; transition: all 0.3s ease !important; text-transform: uppercase !important; letter-spacing: 1px !important; min-height: 80px !important; display: flex !important; align-items: center !important; justify-content: center !important; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important; width: 100% !important; margin-bottom: 15px !important;">
                                БАНЕР О НАС
                            </button>
                        </div>
                    </div>

                    <!-- Контент для помощи -->
                    <div class="content-section" id="helpContent" style="display: none;">
                        <div class="content-buttons">
                            <button class="content-btn" onclick="openContentModal('help', 'hero')" style="background: #2a2a2a !important; color: #ffffff !important; border: 2px solid #444 !important; padding: 30px 20px !important; border-radius: 10px !important; cursor: pointer !important; font-size: 18px !important; font-weight: bold !important; transition: all 0.3s ease !important; text-transform: uppercase !important; letter-spacing: 1px !important; min-height: 80px !important; display: flex !important; align-items: center !important; justify-content: center !important; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important; width: 100% !important; margin-bottom: 15px !important;">
                                БАНЕР ПОМОЩИ
                            </button>
                        </div>
                    </div>

                    <!-- Контент для переходов -->
                    <div class="content-section" id="transitionsContent" style="display: none;">
                        <div class="content-buttons">
                            <button class="content-btn" onclick="openContentModal('transitions', 'block1')" style="background: #2a2a2a !important; color: #ffffff !important; border: 2px solid #444 !important; padding: 30px 20px !important; border-radius: 10px !important; cursor: pointer !important; font-size: 18px !important; font-weight: bold !important; transition: all 0.3s ease !important; text-transform: uppercase !important; letter-spacing: 1px !important; min-height: 80px !important; display: flex !important; align-items: center !important; justify-content: center !important; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important; width: 100% !important; margin-bottom: 15px !important;">
                                БЛОК 1
                            </button>
                            <button class="content-btn" onclick="openContentModal('transitions', 'block2')" style="background: #2a2a2a !important; color: #ffffff !important; border: 2px solid #444 !important; padding: 30px 20px !important; border-radius: 10px !important; cursor: pointer !important; font-size: 18px !important; font-weight: bold !important; transition: all 0.3s ease !important; text-transform: uppercase !important; letter-spacing: 1px !important; min-height: 80px !important; display: flex !important; align-items: center !important; justify-content: center !important; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important; width: 100% !important; margin-bottom: 15px !important;">
                                БЛОК 2
                            </button>
                            <button class="content-btn" onclick="openContentModal('transitions', 'block3')" style="background: #2a2a2a !important; color: #ffffff !important; border: 2px solid #444 !important; padding: 30px 20px !important; border-radius: 10px !important; cursor: pointer !important; font-size: 18px !important; font-weight: bold !important; transition: all 0.3s ease !important; text-transform: uppercase !important; letter-spacing: 1px !important; min-height: 80px !important; display: flex !important; align-items: center !important; justify-content: center !important; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important; width: 100% !important; margin-bottom: 15px !important;">
                                БЛОК 3
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="appeals">
                <h3>Обращения</h3>
                <div class="orders-container">
                    <!-- Фильтры обращений -->
                    <div class="orders-filters">
                        <button class="filter-btn active" data-filter="new" onclick="filterAppeals('new')">
                            Новые заявки
                            <span class="appeal-count" id="newCount">0</span>
                        </button>
                        <button class="filter-btn" data-filter="processed" onclick="filterAppeals('processed')">
                            Обработанные
                            <span class="appeal-count" id="processedCount">0</span>
                        </button>
                    </div>
                    <div class="orders-list" id="appealsList">
                        <!-- Обращения будут загружены здесь -->
                    </div>
                </div>
            </div>

            <div class="tab-content" id="reports">
                <h3>Отчеты</h3>
                <div class="reports-container">
                    <!-- Фильтры отчетов -->
                    <div class="reports-filters">
                        <button class="filter-btn active" data-filter="1" onclick="filterReports('1')">
                            1 день
                        </button>
                        <button class="filter-btn" data-filter="7" onclick="filterReports('7')">
                            Неделя
                        </button>
                        <button class="filter-btn" data-filter="30" onclick="filterReports('30')">
                            Месяц
                        </button>
                        <button class="filter-btn" data-filter="365" onclick="filterReports('365')">
                            Год
                        </button>
                    </div>
                    
                    <!-- Таблица отчетов -->
                    <div class="reports-table-container">
                        <table class="reports-table" id="reportsTable">
                            <thead>
                                <tr>
                                    <th>Дата продажи</th>
                                    <th>Товары в заказе</th>
                                    <th>Количество</th>
                                    <th>Покупатель</th>
                                    <th class="num">Доставка</th>
                                    <th>Промокод</th>
                                    <th class="num">Итоговая цена</th>
                                </tr>
                            </thead>
                            <tbody id="reportsTableBody">
                                <!-- Данные будут загружены динамически -->
                            </tbody>
                        </table>
            </div>
                    
                    <!-- Сводка -->
                    <div class="reports-summary" id="reportsSummary">
                        <!-- Сводка будет загружена динамически -->
                    </div>
                    
                    <!-- Кнопка выгрузки -->
                    <div class="reports-export">
                        <button class="export-btn" onclick="exportToExcel()">
                            📊 Выгрузить HTML отчет
                        </button>
                        <button class="export-btn" onclick="exportToExcelFormat()" style="margin-left: 10px;">
                            📈 Выгрузить Excel
                        </button>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="promocodes">
                <h3>Промокоды</h3>
                <div class="promocodes-container">
                    <!-- Фильтры промокодов -->
                    <div class="promocodes-filters">
                        <button class="filter-btn active" data-filter="all" onclick="filterPromocodes('all')">
                            Все промокоды
                        </button>
                        <button class="filter-btn" data-filter="active" onclick="filterPromocodes('active')">
                            Активные
                        </button>
                        <button class="filter-btn" data-filter="expired" onclick="filterPromocodes('expired')">
                            Истекшие
                        </button>
                    </div>
                    
                    <!-- Кнопка добавления нового промокода -->
                    <div class="promocodes-actions" style="display: flex; justify-content: flex-end;">
                        <button class="add-btn" onclick="openPromocodeModal()">
                            ➕ Добавить промокод
                        </button>
                    </div>
                    
                    <!-- Таблица промокодов -->
                    <div class="promocodes-table-container">
                        <table class="promocodes-table" id="promocodesTable">
                            <thead>
                                <tr>
                                    <th>Код</th>
                                    <th>Тип</th>
                                    <th>Значение</th>
                                    <th>Дата начала</th>
                                    <th>Дата окончания</th>
                                    <th>Использования</th>
                                    <th>Статус</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="promocodesTableBody">
                                <!-- Данные будут загружены динамически -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="discounts">
                <h3>Скидки</h3>
                <div class="discounts-container">
                    <!-- Фильтры скидок -->
                    <div class="discounts-filters">
                        <button class="filter-btn active" data-filter="all" onclick="filterDiscounts('all')">
                            Все скидки
                        </button>
                        <button class="filter-btn" data-filter="active" onclick="filterDiscounts('active')">
                            Активные
                        </button>
                        <button class="filter-btn" data-filter="expired" onclick="filterDiscounts('expired')">
                            Истекшие
                        </button>
                    </div>
                    
                    <!-- Кнопка добавления новой скидки -->
                    <div class="discounts-actions" style="display: flex; justify-content: flex-end;">
                        <button class="add-btn" onclick="openDiscountModal()">
                            ➕ Добавить скидку
                        </button>
                    </div>
                    
                    <!-- Таблица скидок -->
                    <div class="discounts-table-container">
                        <table class="discounts-table" id="discountsTable">
                            <thead>
                                <tr>
                                    <th>Товар</th>
                                    <th>Тип</th>
                                    <th>Значение</th>
                                    <th>Дата начала</th>
                                    <th>Дата окончания</th>
                                    <th>Статус</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="discountsTableBody">
                                <!-- Данные будут загружены динамически -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Предустановленные пользователи
        const adminUsers = [
            {
                login: 'centerkino',
                password: 'kinocenter2025'
            },
            {
                login: 'vladimir_firman',
                password: 'vova_krut'
            },
            {
                login: 'admin_kino',
                password: 'admin_ory'
            }
        ];

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Проверяем, загружен ли Chart.js
            if (typeof Chart === 'undefined') {
                console.error('Chart.js не загружен!');
                return;
            }

            // Сохраняем пользователей в localStorage (обновляем при каждом запуске)
            localStorage.setItem('adminUsers', JSON.stringify(adminUsers));

            // Проверяем размер localStorage
            checkStorageSize();
            
            // Очищаем поврежденные изображения при загрузке
            cleanCorruptedImages();

            // Инициализируем статистику
            initStatistics();
            
            // Генерируем тестовые данные если их нет
            if (!localStorage.getItem('statisticsData') || Object.keys(JSON.parse(localStorage.getItem('statisticsData') || '{}')).length === 0) {
                generateTestData();
            }

            // Проверяем, авторизован ли пользователь
            const isLoggedIn = localStorage.getItem('adminLoggedIn');
            if (isLoggedIn === 'true') {
                showAdminPanel();
                // Инициализируем уведомления о заказах
                initOrderNotifications();
                // Инициализируем систему обращений
                initAppeals();
                // Инициализируем систему отчетов
                initReports();
                // Инициализируем систему промокодов
                initPromocodes();
                // Инициализируем систему скидок
                initDiscounts();
            }

            // Обработчик формы входа
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                login();
            });
        });

        // Функция входа - максимально простая
        function login() {
            // Просто входим без проверок
                localStorage.setItem('adminLoggedIn', 'true');
            localStorage.setItem('adminUser', 'admin');
                showAdminPanel();
            console.log('Вход выполнен (без проверок)');
                // Инициализируем уведомления о заказах
                initOrderNotifications();
                // Инициализируем систему обращений
                initAppeals();
                // Инициализируем систему отчетов
                initReports();
                // Инициализируем систему промокодов
                initPromocodes();
                // Инициализируем систему скидок
                initDiscounts();
        }

        // Функция выхода
        function logout() {
            localStorage.removeItem('adminLoggedIn');
            localStorage.removeItem('adminUser');
            showLoginSection();
        }

        // Функция сброса данных аутентификации (для отладки)
        function resetAuth() {
            localStorage.removeItem('adminLoggedIn');
            localStorage.removeItem('adminUser');
            localStorage.removeItem('adminUsers');
            alert('Данные авторизации сброшены! Страница будет перезагружена.');
            location.reload();
        }
        
        // Функция принудительного входа (для отладки)
        function forceLogin() {
            localStorage.setItem('adminUsers', JSON.stringify(adminUsers));
            localStorage.setItem('adminLoggedIn', 'true');
            localStorage.setItem('adminUser', 'centerkino');
            showAdminPanel();
            alert('Принудительный вход выполнен!');
        }

        // Показать админ панель
        function showAdminPanel() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
        }

        // Показать секцию входа
        function showLoginSection() {
            document.getElementById('loginSection').style.display = 'flex';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('loginForm').reset();
            document.getElementById('errorMessage').textContent = '';
        }



        // Глобальные переменные для статистики
        let statisticsChart = null;
        let statisticsData = {};

        // Инициализация статистики
        function initStatistics() {
            // Создаем структуру данных для статистики если её нет
            if (!localStorage.getItem('statisticsData')) {
                const initialData = {
                    visits: {},
                    orders: {},
                    catalog: {},
                    newArrivals: {},
                    kinoshlep: {},
                    registrations: {}
                };
                localStorage.setItem('statisticsData', JSON.stringify(initialData));
            }
            
            // Загружаем данные
            statisticsData = JSON.parse(localStorage.getItem('statisticsData') || '{}');
            
            // Запускаем автообновление каждые 2 минуты
            setInterval(updateChartData, 120000);
        }

        // Функция для записи статистики
        function recordStatistic(type) {
            const today = new Date().toISOString().split('T')[0];
            
            if (!statisticsData[type]) {
                statisticsData[type] = {};
            }
            
            if (!statisticsData[type][today]) {
                statisticsData[type][today] = 0;
            }
            
            statisticsData[type][today]++;
            localStorage.setItem('statisticsData', JSON.stringify(statisticsData));
            
            // Обновляем график если он открыт
            if (statisticsChart) {
                updateChartData();
            }
        }

        // Функция для записи статистики посещений (с уникальными IP) - только для админ панели
        function adminRecordVisit() {
            const today = new Date().toISOString().split('T')[0];
            const visitorId = adminGenerateVisitorId();
            
            if (!statisticsData.visits) {
                statisticsData.visits = {};
            }
            
            if (!statisticsData.visits[today]) {
                statisticsData.visits[today] = new Set();
            }
            
            // Если это Set, конвертируем в обычный объект
            if (statisticsData.visits[today] instanceof Set) {
                statisticsData.visits[today].add(visitorId);
            } else {
                // Если это число, создаем новый Set
                statisticsData.visits[today] = new Set([visitorId]);
            }
            
            // Сохраняем как массив для localStorage
            const visitsArray = Array.from(statisticsData.visits[today]);
            localStorage.setItem('statisticsData', JSON.stringify(statisticsData));
            
            // Обновляем график если он открыт
            if (statisticsChart) {
                updateChartData();
            }
        }

        // Генерация уникального ID посетителя - только для админ панели
        function adminGenerateVisitorId() {
            const userAgent = navigator.userAgent;
            const screenRes = `${screen.width}x${screen.height}`;
            const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const language = navigator.language;
            
            // Создаем хеш из характеристик браузера
            const hash = btoa(`${userAgent}-${screenRes}-${timeZone}-${language}`).slice(0, 16);
            return hash;
        }

        // Инициализация графика
        function initStatisticsChart() {
            console.log('Инициализация графика...');
            
            const ctx = document.getElementById('statisticsChart');
            if (!ctx) {
                console.error('Canvas элемент не найден!');
                return;
            }

            // Проверяем, загружен ли Chart.js
            if (typeof Chart === 'undefined') {
                console.error('Chart.js не загружен!');
                return;
            }

            // Уничтожаем предыдущий график если он существует
            if (statisticsChart) {
                statisticsChart.destroy();
            }

            // Загружаем актуальные данные
            statisticsData = JSON.parse(localStorage.getItem('statisticsData') || '{}');
            console.log('Данные статистики:', statisticsData);

            const data = generateChartData();
            console.log('Данные для графика:', data);
            
            try {
                statisticsChart = new Chart(ctx, {
                    type: 'line',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#ffffff'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Статистика посещений и действий',
                                color: '#ffffff',
                                font: {
                                    size: 16
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Дни',
                                    color: '#ffffff'
                                },
                                ticks: {
                                    color: '#ffffff'
                                },
                                grid: {
                                    color: '#444'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Количество',
                                    color: '#ffffff'
                                },
                                ticks: {
                                    color: '#ffffff',
                                    beginAtZero: true,
                                    min: 0,
                                    stepSize: 1,
                                    callback: function(value) {
                                        return Math.floor(value);
                                    }
                                },
                                grid: {
                                    color: '#444'
                                },
                                beginAtZero: true
                            }
                        }
                    }
                });
                console.log('График успешно создан!');
            } catch (error) {
                console.error('Ошибка при создании графика:', error);
            }
        }

        // Генерация данных для графика
        function generateChartData() {
            const period = parseInt(document.getElementById('periodSelect').value);
            const selectedCategories = getSelectedCategories();
            
            // Генерируем даты для выбранного периода
            const dates = [];
            const today = new Date();
            
            for (let i = period - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                dates.push(date.toISOString().split('T')[0]);
            }

            const datasets = [];
            const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];

            selectedCategories.forEach((category, index) => {
                const data = dates.map(date => {
                    let value = 0;
                    
                    if (statisticsData[category] && statisticsData[category][date]) {
                        if (category === 'visits') {
                            // Для посещений считаем уникальных посетителей
                            const visitsData = statisticsData[category][date];
                            if (Array.isArray(visitsData)) {
                                value = visitsData.length;
                            } else if (typeof visitsData === 'number') {
                                value = visitsData;
                            }
                        } else {
                            value = statisticsData[category][date];
                        }
                    }
                    
                    return Math.max(0, value); // Гарантируем, что значение не меньше 0
                });

                datasets.push({
                    label: getCategoryLabel(category),
                    data: data,
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4
                });
            });

            return {
                labels: dates.map(date => {
                    const d = new Date(date);
                    return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
                }),
                datasets: datasets
            };
        }

        // Получение выбранных категорий
        function getSelectedCategories() {
            const checkboxes = document.querySelectorAll('.category-checkboxes input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // Получение названия категории
        function getCategoryLabel(category) {
            const labels = {
                visits: 'Посещения сайта',
                orders: 'Оформленные заказы',
                catalog: 'Переход в каталог',
                newArrivals: 'Переход в новые поступления',
                kinoshlep: 'Переход на ссылку: КИНОШЛЕП',
                registrations: 'Зарегистрировавшиеся пользователи'
            };
            return labels[category] || category;
        }

        // Обновление данных графика
        function updateChartData() {
            // Перезагружаем данные из localStorage
            statisticsData = JSON.parse(localStorage.getItem('statisticsData') || '{}');
            
            if (statisticsChart) {
                const newData = generateChartData();
                statisticsChart.data = newData;
                statisticsChart.update('none'); // Обновляем без анимации для плавности
            }
        }

        // Обновление графика при изменении настроек
        function updateChart() {
            updateChartData();
        }

        // Экспорт статистики в Excel формат
        function exportStatistics() {
            const period = parseInt(document.getElementById('periodSelect').value);
            const selectedCategories = getSelectedCategories();
            
            if (selectedCategories.length === 0) {
                alert('Выберите хотя бы одну категорию для экспорта');
                return;
            }

            // Генерируем данные для экспорта
            const dates = [];
            const today = new Date();
            
            for (let i = period - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                dates.push(date.toISOString().split('T')[0]);
            }

            // Создаем Excel-совместимый HTML файл для каждой категории
            selectedCategories.forEach(category => {
                const categoryLabel = getCategoryLabel(category);
                
                // Подготавливаем данные для Excel
                const excelData = [];
                
                // Заголовки
                excelData.push([
                    'Категория',
                    'Дата',
                    'Количество'
                ]);
                
                // Данные
                dates.forEach(date => {
                    let value = 0;
                    
                    if (statisticsData[category] && statisticsData[category][date]) {
                        if (category === 'visits') {
                            // Для посещений считаем уникальных посетителей
                            const visitsData = statisticsData[category][date];
                            if (Array.isArray(visitsData)) {
                                value = visitsData.length;
                            } else if (typeof visitsData === 'number') {
                                value = visitsData;
                            }
                        } else {
                            value = statisticsData[category][date];
                        }
                    }
                    
                    // Форматируем дату для Excel (DD.MM.YYYY)
                    const orderDate = new Date(date);
                    const formattedDate = `${orderDate.getDate().toString().padStart(2, '0')}.${(orderDate.getMonth() + 1).toString().padStart(2, '0')}.${orderDate.getFullYear()}`;
                    
                    excelData.push([
                        categoryLabel,
                        formattedDate,
                        Math.max(0, value)
                    ]);
                });

                // Создаем HTML таблицу для Excel с правильным форматированием
                const htmlContent = `
<!DOCTYPE html>
<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Статистика - ${categoryLabel}</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            font-family: Arial, sans-serif;
            font-size: 12px;
        }
        th {
            background-color: #4472C4;
            color: white;
            font-weight: bold;
            text-align: center;
            padding: 8px;
            border: 1px solid #000000;
        }
        td {
            padding: 6px;
            border: 1px solid #000000;
            text-align: left;
            vertical-align: top;
        }
        .number {
            text-align: right;
            mso-number-format: "#,##0";
        }
        .date {
            text-align: center;
            mso-number-format: "dd.mm.yyyy";
        }
        .category {
            text-align: left;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <table>
        <thead>
            <tr>
                <th>Категория</th>
                <th>Дата</th>
                <th>Количество</th>
            </tr>
        </thead>
        <tbody>
            ${excelData.slice(1).map(row => `
                <tr>
                    <td class="category">${row[0]}</td>
                    <td class="date">${row[1]}</td>
                    <td class="number">${row[2]}</td>
                </tr>
            `).join('')}
        </tbody>
    </table>
</body>
</html>`;

                // Создаем и скачиваем файл
                const currentDate = new Date().toLocaleDateString('ru-RU').replace(/\./g, '-');
                const fileName = `статистика_${categoryLabel}_${currentDate}.xls`;
                
                const blob = new Blob([htmlContent], { type: 'application/vnd.ms-excel;charset=utf-8' });
                const link = document.createElement('a');
                
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', fileName);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    setTimeout(() => {
                        URL.revokeObjectURL(url);
                    }, 100);
                } else {
                    // Fallback для старых браузеров
                    window.open('data:application/vnd.ms-excel;charset=utf-8,' + encodeURIComponent(htmlContent));
                }
            });
        }

        // Экспорт статистики в красивый HTML отчёт (по выбранным категориям и периоду)
        function exportStatisticsHTML() {
            const period = parseInt(document.getElementById('periodSelect').value);
            const selectedCategories = getSelectedCategories();

            if (selectedCategories.length === 0) {
                alert('Выберите хотя бы одну категорию для экспорта');
                return;
            }

            // Генерируем список дат
            const dates = [];
            const today = new Date();
            for (let i = period - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                dates.push(date);
            }

            // Строим HTML
            const periodTextMap = { '1':'1 день', '3':'3 дня', '7':'7 дней', '30':'Месяц', '90':'3 месяца', '180':'6 месяцев', '365':'12 месяцев' };
            const periodText = periodTextMap[String(period)] || `${period} дней`;
            const nowStr = new Date().toLocaleString('ru-RU');

            let tablesHTML = '';
            selectedCategories.forEach(category => {
                const label = getCategoryLabel(category);
                let rows = '';
                dates.forEach(d => {
                    const key = d.toISOString().split('T')[0];
                    let value = 0;
                    if (statisticsData[category] && statisticsData[category][key]) {
                        if (category === 'visits') {
                            const visitsData = statisticsData[category][key];
                            value = Array.isArray(visitsData) ? visitsData.length : (typeof visitsData === 'number' ? visitsData : 0);
                        } else {
                            value = statisticsData[category][key];
                        }
                    }
                    rows += `<tr><td class="date">${d.toLocaleDateString('ru-RU')}</td><td class="num">${Math.max(0, value)}</td></tr>`;
                });

                tablesHTML += `
                <div class="section">
                    <div class="section-title">${label}</div>
                    <table class="stat-table">
                        <thead>
                            <tr><th>Дата</th><th class="num">Значение</th></tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                </div>`;
            });

            const html = `
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Статистика — Центр Кино™</title>
    <style>
        body { font-family: Arial, Helvetica, sans-serif; background:#fff; color:#222; padding:20px; }
        .header { text-align:center; margin-bottom:25px; }
        .title { font-size:24px; font-weight:700; }
        .subtitle { color:#666; margin-top:6px; }
        .controls { text-align:center; margin-bottom:20px; }
        .btn { display:inline-block; background:#000; color:#fff; border:none; padding:10px 16px; border-radius:6px; cursor:pointer; margin:0 6px; }
        .btn.secondary { background:#666; }
        .section { margin:22px 0; }
        .section-title { font-weight:700; margin-bottom:10px; }
        .stat-table { width:100%; border-collapse:collapse; background:#fff; }
        .stat-table th { background:#111; color:#fff; text-align:left; padding:10px; }
        .stat-table td { padding:10px; border-bottom:1px solid #eee; }
        .num { text-align:right; }
        .date { white-space:nowrap; }
        @media print { .controls { display:none !important; } }
    </style>
    </head>
    <body>
        <div class="controls">
            <button class="btn" onclick="window.print()">Печать</button>
            <button class="btn secondary" onclick="window.close()">Закрыть</button>
        </div>
        <div class="header">
            <div class="title">Статистика — Центр Кино™</div>
            <div class="subtitle">Период: ${periodText} · Сформировано: ${nowStr}</div>
        </div>
        ${tablesHTML}
    </body>
</html>`;

            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `статистика_${new Date().toISOString().slice(0,10)}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 200);
        }

        // Генерация тестовых данных (для демонстрации)
        function generateTestData() {
            const today = new Date();
            const testData = {
                visits: {},
                orders: {},
                catalog: {},
                newArrivals: {},
                kinoshlep: {},
                registrations: {}
            };

            // Генерируем данные начиная с 30 июля
            const startDate = new Date('2024-07-30');
            const daysDiff = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
            
            for (let i = 0; i <= daysDiff; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                
                // Генерируем уникальных посетителей
                const uniqueVisitors = [];
                const visitorCount = Math.floor(Math.random() * 50) + 30;
                for (let j = 0; j < visitorCount; j++) {
                    uniqueVisitors.push(`visitor_${Math.random().toString(36).substr(2, 9)}`);
                }
                testData.visits[dateStr] = uniqueVisitors;
                
                testData.orders[dateStr] = Math.floor(Math.random() * 15) + 3;
                testData.catalog[dateStr] = Math.floor(Math.random() * 35) + 15;
                testData.newArrivals[dateStr] = Math.floor(Math.random() * 25) + 10;
                testData.kinoshlep[dateStr] = Math.floor(Math.random() * 8) + 1;
                testData.registrations[dateStr] = Math.floor(Math.random() * 5) + 1;
            }

            localStorage.setItem('statisticsData', JSON.stringify(testData));
            statisticsData = testData;
        }

        // Принудительная инициализация графика
        function forceInitChart() {
            console.log('Принудительная инициализация графика...');
            initStatisticsChart();
        }



        function updateOrderStatus(orderId, newStatus) {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const orderIndex = orders.findIndex(order => order.id === orderId);
            
            if (orderIndex !== -1) {
                orders[orderIndex].status = newStatus;
                
                // Если статус "Отправлен", показываем секцию трекинга
                if (newStatus === 'Отправлен') {
                    // Перезагружаем заказы чтобы показать секцию трекинга
                    setTimeout(() => loadOrders(), 100);
                }
                
                localStorage.setItem('orders', JSON.stringify(orders));
                console.log(`Статус заказа ${orderId} изменен на: ${newStatus}`);
            }
        }

        function updateTrackingNumber(orderId, trackingNumber) {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const orderIndex = orders.findIndex(order => order.id === orderId);
            
            if (orderIndex !== -1) {
                orders[orderIndex].trackingNumber = trackingNumber;
                localStorage.setItem('orders', JSON.stringify(orders));
            }
        }

        function updateTrackingLink(orderId, trackingLink) {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const orderIndex = orders.findIndex(order => order.id === orderId);
            
            if (orderIndex !== -1) {
                orders[orderIndex].trackingLink = trackingLink;
                localStorage.setItem('orders', JSON.stringify(orders));
            }
        }

        function confirmTracking(orderId) {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const orderIndex = orders.findIndex(order => order.id === orderId);
            
            if (orderIndex !== -1) {
                const order = orders[orderIndex];
                if (order.trackingLink) {
                    // Сворачиваем секцию трекинга и перезагружаем заказы
                    orders[orderIndex].trackingConfirmed = true;
                    localStorage.setItem('orders', JSON.stringify(orders));
                    loadOrders(); // Перезагружаем для обновления отображения
                    console.log(`Трекинг подтвержден для заказа ${orderId}`);
                } else {
                    console.log('Ссылка для отслеживания не заполнена');
                }
            }
        }

        function expandTrackingSection(orderId) {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const orderIndex = orders.findIndex(order => order.id === orderId);
            
            if (orderIndex !== -1) {
                // Убираем флаг подтверждения и перезагружаем заказы
                orders[orderIndex].trackingConfirmed = false;
                localStorage.setItem('orders', JSON.stringify(orders));
                loadOrders(); // Перезагружаем для обновления отображения
            }
        }

        // Получение данных товара из localStorage
        function getProductData(productId) {
            // Сначала ищем в админ панели (ключи product_${id})
            const productData = localStorage.getItem(`product_${productId}`);
            if (productData) {
                try {
                    const product = JSON.parse(productData);
                    return product;
                } catch (error) {
                    console.error('Ошибка при загрузке товара из админ панели:', error);
                }
            }
            
            // Если не найден в админ панели, ищем в старых данных
            const oldProducts = JSON.parse(localStorage.getItem('products') || '[]');
            const product = oldProducts.find(p => p.id === parseInt(productId));
            
            if (product) {
                return product;
            }
            
            // Возвращаем дефолтные данные, если товар не найден
            return {
                id: parseInt(productId),
                name: 'Товар не найден',
                category: 'Неизвестно',
                price: 0,
                images: []
            };
        }

        // Глобальные переменные для фильтрации и уведомлений
        let currentFilter = 'all';
        let lastViewedOrderId = null;
        let currentPage = 1;
        const ordersPerPage = 6;

        // Инициализация уведомлений о заказах
        function initOrderNotifications() {
            console.log('Инициализация уведомлений о заказах...');
            
            // Загружаем последний просмотренный заказ из localStorage
            const savedLastViewed = localStorage.getItem('lastViewedOrderId');
            if (savedLastViewed) {
                lastViewedOrderId = parseInt(savedLastViewed);
                console.log(`Загружен последний просмотренный заказ из localStorage: ${lastViewedOrderId}`);
            } else {
                // Если нет сохраненного значения, устанавливаем в 0 (показывать все заказы как новые)
                lastViewedOrderId = 0;
                localStorage.setItem('lastViewedOrderId', lastViewedOrderId);
                console.log('Установлен последний просмотренный заказ в 0 (все заказы будут показаны как новые)');
            }
            
            // Запускаем проверку новых заказов каждые 10 секунд
            setInterval(checkNewOrders, 10000);
            console.log('Таймер проверки новых заказов запущен (каждые 10 секунд)');
            
            // Проверяем сразу при загрузке
            checkNewOrders();
        }

        // Проверка новых заказов
        function checkNewOrders() {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const lastViewed = parseInt(localStorage.getItem('lastViewedOrderId') || '0');
            
            // Находим новые заказы (с ID больше последнего просмотренного)
            const newOrders = orders.filter(order => order.id > lastViewed);
            
            const notificationBadge = document.getElementById('ordersNotification');
            if (newOrders.length > 0) {
                notificationBadge.textContent = newOrders.length;
                notificationBadge.style.display = 'flex';
                console.log(`Найдено ${newOrders.length} новых заказов`);
            } else {
                notificationBadge.style.display = 'none';
            }
        }

        // Фильтрация заказов
        function filterOrders(filter) {
            currentFilter = filter;
            currentPage = 1; // Сбрасываем на первую страницу при смене фильтра
            
            // Обновляем активную кнопку фильтра
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
            
            // Загружаем отфильтрованные заказы
            loadOrders();
        }

        // Обновленная функция загрузки заказов с фильтрацией и пагинацией
        function loadOrders() {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const ordersList = document.getElementById('ordersList');
            const paginationContainer = document.getElementById('ordersPagination');
            
            // Фильтруем заказы по статусу
            let filteredOrders = orders;
            if (currentFilter !== 'all') {
                filteredOrders = orders.filter(order => order.status === currentFilter);
            }
            
            if (filteredOrders.length === 0) {
                const filterText = currentFilter === 'all' ? 'Заказов пока нет' : 
                                 `Заказов со статусом "${currentFilter}" нет`;
                ordersList.innerHTML = `<p style="color: #888; text-align: center;">${filterText}</p>`;
                paginationContainer.innerHTML = '';
                return;
            }

            // Сортируем заказы по дате (новые сначала)
            filteredOrders.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Пагинация
            const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
            const startIndex = (currentPage - 1) * ordersPerPage;
            const endIndex = startIndex + ordersPerPage;
            const paginatedOrders = filteredOrders.slice(startIndex, endIndex);

            ordersList.innerHTML = paginatedOrders.map(order => `
                <div class="order-item">
                    <div class="order-header">
                        <div class="order-info">
                            <h4>Заказ #${order.orderNumber}</h4>
                            <p>Дата: ${new Date(order.date).toLocaleDateString('ru-RU')}</p>
                            <p>Email: ${order.userEmail}</p>
                            <p>Сумма: ${order.total.toLocaleString()} ₽</p>
                            ${order.userProfile ? `
                                <div class="user-profile-info">
                                    <h5>Информация о пользователе:</h5>
                                    <p>ФИО: ${order.userProfile.lastName || ''} ${order.userProfile.firstName || ''} ${order.userProfile.middleName || ''}</p>
                                    <p>Телефон: ${order.userProfile.phone || ''}</p>
                                    <p>Адрес: ${order.userProfile.postalCode || ''}, ${order.userProfile.country || ''}, ${order.userProfile.city || ''}, ${order.userProfile.street || ''}, ${order.userProfile.house || ''}${order.userProfile.apartment ? ', кв. ' + order.userProfile.apartment : ''}</p>
                                    ${order.userProfile.messenger ? `<p>Мессенджер: ${order.userProfile.messenger}</p>` : ''}
                                </div>
                            ` : ''}
                        </div>
                        <div class="order-status-controls">
                            <select class="status-select" onchange="updateOrderStatus(${order.id}, this.value)">
                                <option value="В сборке" ${order.status === 'В сборке' ? 'selected' : ''}>В сборке</option>
                                <option value="Отправлен" ${order.status === 'Отправлен' ? 'selected' : ''}>Отправлен</option>
                                <option value="Доставлен" ${order.status === 'Доставлен' ? 'selected' : ''}>Доставлен</option>
                            </select>
                            ${order.status === 'Отправлен' ? `
                                <div class="tracking-section ${order.trackingConfirmed ? 'collapsed' : 'show'}" data-order-id="${order.id}">
                                    ${order.trackingConfirmed ? `
                                        <button class="expand-btn" onclick="expandTrackingSection(${order.id})">+</button>
                                    ` : ''}
                                    <div class="tracking-inputs">
                                        <input type="text" class="tracking-input" placeholder="Трек номер (необязательно)" 
                                               value="${order.trackingNumber || ''}" 
                                               onchange="updateTrackingNumber(${order.id}, this.value)">
                                        <input type="text" class="tracking-input" placeholder="Ссылка для отслеживания" 
                                               value="${order.trackingLink || ''}" 
                                               onchange="updateTrackingLink(${order.id}, this.value)">
                                        <button class="confirm-btn" onclick="confirmTracking(${order.id})">Подтвердить</button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="order-items">
                        ${order.items.map(item => {
                            // Получаем полные данные товара для отображения изображения
                            const productData = getProductData(item.id);
                            const productImage = productData.images && productData.images.length > 0 ? productData.images[0] : null;
                            
                            return `
                            <div class="order-item-detail">
                                <div class="item-image">
                                    ${productImage ? 
                                        `<img src="${productImage}" alt="${item.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;">` :
                                        `<div class="item-number">${item.id}</div>`
                                    }
                                </div>
                                <div class="item-details">
                                    <div class="item-name">${item.name}</div>
                                    <div class="item-info">Размер: ${item.size}</div>
                                    <div class="item-info">Цвет: ${item.color}</div>
                                    <div class="item-info">Количество: ${item.quantity}</div>
                                    <div class="item-info">Цена: ${item.price.toLocaleString()} ₽</div>
                                </div>
                            </div>
                        `;
                        }).join('')}
                    </div>
                </div>
            `).join('');

            // Генерируем пагинацию
            generatePagination(totalPages, currentPage);
        }

        // Функция генерации пагинации
        function generatePagination(totalPages, currentPage) {
            const paginationContainer = document.getElementById('ordersPagination');
            
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }

            let paginationHTML = '';
            
            // Кнопка "Предыдущая"
            paginationHTML += `<button class="pagination-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Предыдущая</button>`;
            
            // Номера страниц
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    paginationHTML += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    paginationHTML += `<span class="pagination-btn" style="cursor: default;">...</span>`;
                }
            }
            
            // Кнопка "Следующая"
            paginationHTML += `<button class="pagination-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Следующая</button>`;
            
            paginationContainer.innerHTML = paginationHTML;
        }

        // Функция смены страницы
        function changePage(page) {
            currentPage = page;
            loadOrders();
        }

        // Обновленная функция показа вкладки заказов
        function showTab(tabName) {
            console.log('Переключение на вкладку:', tabName);
            
            // Скрываем все вкладки
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Показываем выбранную вкладку
            document.getElementById(tabName).classList.add('active');
            
            // Если открывается статистика, инициализируем график
            if (tabName === 'statistics') {
                // Добавляем небольшую задержку для корректного отображения canvas
                setTimeout(() => {
                    console.log('Инициализация графика статистики...');
                    initStatisticsChart();
                }, 100);
            }
            
            // Если открывается заказы, загружаем список заказов и скрываем уведомление
            if (tabName === 'orders') {
                setTimeout(() => {
                    console.log('Загрузка заказов...');
                    loadOrders();
                    // Скрываем уведомление и обновляем последний просмотренный заказ
                    hideOrderNotification();
                    console.log('Уведомление о заказах скрыто');
                }, 100);
            }
            
            // Если открывается товары, загружаем список товаров
            if (tabName === 'products') {
                setTimeout(() => {
                    console.log('Загрузка товаров...');
                    loadProducts();
                }, 100);
            }
            
            // Если открывается обращения, загружаем список обращений и скрываем уведомление
            if (tabName === 'appeals') {
                setTimeout(() => {
                    console.log('Загрузка обращений...');
                    loadAppeals();
                    // Скрываем уведомление и обновляем последний просмотренный обращение
                    hideAppealsNotification();
                    console.log('Уведомление о обращениях скрыто');
                }, 100);
            }
            
            // Если открывается отчеты, загружаем отчеты
            if (tabName === 'reports') {
                setTimeout(() => {
                    console.log('Загрузка отчетов...');
                    loadReports();
                }, 100);
            }
        }

        // Скрытие уведомления о заказах
        function hideOrderNotification() {
            const notificationBadge = document.getElementById('ordersNotification');
            notificationBadge.style.display = 'none';
            
            // Обновляем последний просмотренный заказ
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            if (orders.length > 0) {
                const maxOrderId = Math.max(...orders.map(order => order.id));
                localStorage.setItem('lastViewedOrderId', maxOrderId);
                lastViewedOrderId = maxOrderId;
                console.log(`Уведомление скрыто, последний просмотренный заказ: ${maxOrderId}`);
            }
        }

        // ===== ФУНКЦИИ УПРАВЛЕНИЯ ТОВАРАМИ =====

        // Глобальные переменные для товаров
        let editingProductId = null;

        // Инициализация товаров при первом запуске
        function initProducts() {
            console.log('Функция initProducts вызвана');
            
            // Просто загружаем существующие товары, не создаем дефолтные
            loadProducts();
        }

        // Показать форму добавления товара
        function showAddProductForm() {
            editingProductId = null;
            document.getElementById('productFormTitle').textContent = 'Добавить новый товар';
            clearProductForm();
            document.getElementById('productFormContainer').style.display = 'block';
            console.log('Форма добавления товара открыта, editingProductId:', editingProductId);
        }

        // Показать форму редактирования товара
        function showEditProductForm(productId) {
            console.log('Попытка редактирования товара с ID:', productId);
            editingProductId = productId;
            document.getElementById('productFormTitle').textContent = 'Редактировать товар';
            
            const productData = localStorage.getItem(`product_${productId}`);
            if (productData) {
                try {
                    const product = JSON.parse(productData);
                    console.log('Найденный товар:', product);
                    console.log('Заполняем форму данными товара...');
                    fillProductForm(product);
                    document.getElementById('productFormContainer').style.display = 'block';
                    console.log('Форма редактирования открыта');
                } catch (error) {
                    console.error('Ошибка при загрузке товара:', error);
                    alert('Ошибка при загрузке товара!');
                }
            } else {
                console.error('Товар с ID', productId, 'не найден!');
                alert('Товар не найден!');
            }
        }

        // Скрыть форму товара
        function hideProductForm() {
            document.getElementById('productFormContainer').style.display = 'none';
            editingProductId = null;
            clearProductForm();
        }

        // Очистить форму товара
        function clearProductForm() {
            document.getElementById('productId').value = '';
            document.getElementById('productArticle').value = '';
            document.getElementById('productName').value = '';
            document.getElementById('productDescription').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productCategory').value = '';
            document.getElementById('productMaterial').value = '';
            document.getElementById('productSeason').value = '';
            document.getElementById('productStyle').value = '';
            document.getElementById('productCountry').value = '';
            document.getElementById('productSizes').value = '';
            document.getElementById('productColors').value = '';
            document.getElementById('productImages').value = '';
            document.getElementById('productWashing').value = '';
            document.getElementById('productComposition').value = '';
            document.getElementById('productCare').value = '';
            
            // Очищаем кнопки размеров и цветов
            document.querySelectorAll('#sizesContainer .option-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelectorAll('#colorsContainer .option-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Очищаем категории
            document.querySelectorAll('.category-checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Очищаем превью изображений
            for (let i = 1; i <= 4; i++) {
                const previewContainer = document.getElementById(`imagePreview${i}`);
                if (previewContainer) {
                    previewContainer.innerHTML = '';
                }
                const fileInput = document.getElementById(`imageUpload${i}`);
                if (fileInput) {
                    fileInput.value = '';
                }
            }
            
            // Сбрасываем editingProductId при очистке формы
            editingProductId = null;
        }

        // Заполнить форму данными товара
        function fillProductForm(product) {
            console.log('Заполняем форму товаром:', product);
            
            try {
                document.getElementById('productId').value = product.id;
                document.getElementById('productArticle').value = product.article;
                document.getElementById('productName').value = product.name;
                document.getElementById('productDescription').value = product.description;
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productCategory').value = product.category;
                document.getElementById('productMaterial').value = product.material;
                document.getElementById('productSeason').value = product.season;
                document.getElementById('productStyle').value = product.style;
                document.getElementById('productCountry').value = product.country;
                document.getElementById('productSizes').value = product.sizes.join(', ');
                document.getElementById('productColors').value = product.colors.join(', ');
            // Сохраняем изображения в скрытое поле как JSON, чтобы не ломать data URL (там есть запятые)
            document.getElementById('productImages').value = JSON.stringify(product.images);
                document.getElementById('productWashing').value = product.washing;
                document.getElementById('productComposition').value = product.composition;
                document.getElementById('productCare').value = product.care;
                
                console.log('Основные поля заполнены');
            } catch (error) {
                console.error('Ошибка при заполнении основных полей:', error);
            }
            
            // Заполняем кнопки размеров
            document.querySelectorAll('#sizesContainer .option-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (product.sizes.includes(btn.dataset.value)) {
                    btn.classList.add('selected');
                }
            });
            
            // Обновляем скрытое поле размеров
            updateHiddenInput('productSizes', '#sizesContainer .option-btn.selected');
            
            // Заполняем кнопки цветов
            document.querySelectorAll('#colorsContainer .option-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (product.colors.includes(btn.dataset.value)) {
                    btn.classList.add('selected');
                }
            });
            
            // Обновляем скрытое поле цветов
            updateHiddenInput('productColors', '#colorsContainer .option-btn.selected');
            
            // Заполняем категории
            const categories = Array.isArray(product.category) ? product.category : (product.category ? product.category.split(',').map(c => c.trim()) : []);
            document.querySelectorAll('.category-checkboxes input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = categories.includes(checkbox.value);
            });
            
            // Обновляем скрытое поле категорий
            updateHiddenInput('productCategory', '.category-checkboxes input[type="checkbox"]:checked');
            
            // Заполняем превью изображений
            const images = Array.isArray(product.images) ? product.images : (product.images ? product.images.split(',').map(img => img.trim()) : []);
            for (let i = 1; i <= 4; i++) {
                const previewContainer = document.getElementById(`imagePreview${i}`);
                if (previewContainer && images[i-1] && images[i-1] !== '') {
                    previewContainer.innerHTML = `
                        <img src="${images[i-1]}" alt="Preview ${i}">
                        <button type="button" class="remove-image" onclick="removeSingleImage(${i})">×</button>
                    `;
                } else if (previewContainer) {
                    previewContainer.innerHTML = '';
                }
            }
            
            // Обновляем скрытое поле с изображениями
            updateImagesHiddenInput();
        }

                // Сохранить товар
        function saveProduct() {
            try {
                console.log('Сохранение товара...');
                console.log('editingProductId:', editingProductId);
                
                const productData = {
                    id: parseInt(document.getElementById('productId').value),
                    article: document.getElementById('productArticle').value,
                    name: document.getElementById('productName').value,
                    description: document.getElementById('productDescription').value,
                    price: parseInt(document.getElementById('productPrice').value),
                    category: document.getElementById('productCategory').value,
                    material: document.getElementById('productMaterial').value,
                    season: document.getElementById('productSeason').value,
                    style: document.getElementById('productStyle').value,
                    country: document.getElementById('productCountry').value,
                    sizes: document.getElementById('productSizes').value ? document.getElementById('productSizes').value.split(',').map(s => s.trim()).filter(s => s) : [],
                    colors: document.getElementById('productColors').value ? document.getElementById('productColors').value.split(',').map(s => s.trim()).filter(s => s) : [],
                // Читаем изображения из скрытого поля (JSON). Фолбэк: если попадет строка без JSON, завернем её в массив
                images: (function(){
                    const raw = document.getElementById('productImages').value;
                    if (!raw) return [];
                    try {
                        const parsed = JSON.parse(raw);
                        return Array.isArray(parsed) ? parsed : (typeof parsed === 'string' ? [parsed] : []);
                    } catch (_) {
                        // Старый формат через join(','): не поддерживаем, чтобы не ломать base64. Возвращаем пустой массив.
                        return [];
                    }
                })(),
                    washing: document.getElementById('productWashing').value,
                    composition: document.getElementById('productComposition').value,
                    care: document.getElementById('productCare').value
                };
                
                console.log('Данные товара для сохранения:', productData);

                // Валидация
                if (!productData.id || !productData.name || !productData.price) {
                    alert('Пожалуйста, заполните обязательные поля: ID, название и цена');
                    return;
                }

                // Сохраняем каждый товар отдельно
                try {
                    if (editingProductId !== null) {
                        // Редактирование существующего товара
                        localStorage.setItem(`product_${editingProductId}`, JSON.stringify(productData));
                        console.log('Товар обновлен:', productData);
                    } else {
                        // Добавление нового товара
                        // Проверяем, существует ли товар с таким ID
                        if (localStorage.getItem(`product_${productData.id}`)) {
                            alert('Товар с таким ID уже существует!');
                            return;
                        }
                        localStorage.setItem(`product_${productData.id}`, JSON.stringify(productData));
                        console.log('Новый товар добавлен:', productData);
                    }
                } catch (error) {
                    if (error.name === 'QuotaExceededError') {
                        alert('Ошибка: превышен лимит хранилища! Удалите некоторые товары или попробуйте загрузить изображения меньшего размера.');
                        return;
                    } else {
                        throw error;
                    }
                }

                // Обновляем список ID товаров
                updateProductsList();

                // Обновляем список товаров для выбора в модальных окнах
                updateProductsForSelection();

                hideProductForm();
                loadProducts();
                
                // Проверяем размер localStorage после сохранения
                checkStorageSize();
                
                alert(editingProductId !== null ? 'Товар успешно обновлен!' : 'Товар успешно добавлен!');
            } catch (error) {
                console.error('Ошибка при сохранении товара:', error);
                alert('Ошибка при сохранении товара: ' + error.message);
            }
        }

        // Удалить товар
        function deleteProduct(productId) {
            if (confirm('Вы уверены, что хотите удалить этот товар?')) {
                localStorage.removeItem(`product_${productId}`);
                updateProductsList();
                updateProductsForSelection();
                loadProducts();
                alert('Товар успешно удален!');
            }
        }

        // Загрузить список товаров
        function loadProducts() {
            console.log('Загрузка списка товаров...');
            const products = getAllProducts();
            const productsList = document.getElementById('productsList');
            
            console.log('Найдено товаров:', products.length);
            
            if (products.length === 0) {
                console.log('Товаров нет, показываем сообщение');
                productsList.innerHTML = '<p style="color: #888; text-align: center; grid-column: 1 / -1;">Товаров пока нет</p>';
                return;
            }

            // Восстановленная функция для рендера списка товаров
            function renderProductsList(products) {
                return products.map(product => `
                    <div class="product-item">
                        <div class="product-header">
                            <div class="product-info">
                                <h4>
                                    ${product.name}
                                </h4>
                                <p><strong>ID:</strong> ${product.id}</p>
                                <p><strong>Артикул:</strong> ${product.article}</p>
                                <p><strong>Цена:</strong> ${product.price.toLocaleString()} ₽</p>
                                <p><strong>Категория:</strong> ${product.category}</p>
                            </div>
                            <div class="product-actions">
                                <button class="edit-product-btn" onclick="showEditProductForm(${product.id})">
                                    ✏️ Редактировать
                                </button>
                                <button class="delete-product-btn" onclick="deleteProduct(${product.id})">
                                    🗑️ Удалить
                                </button>
                            </div>
                        </div>
                        <div class="product-details">
                            <h5>Детали товара:</h5>
                            <p><strong>Описание:</strong> ${product.description}</p>
                            <p><strong>Материал:</strong> ${product.material}</p>
                            <p><strong>Сезон:</strong> ${product.season}</p>
                            <p><strong>Стиль:</strong> ${product.style}</p>
                            <p><strong>Страна:</strong> ${product.country}</p>
                            <p><strong>Размеры:</strong> ${product.sizes.join(', ')}</p>
                            <p><strong>Цвета:</strong> ${product.colors.join(', ')}</p>
                            <p><strong>Стирка:</strong> ${product.washing}</p>
                            <p><strong>Состав:</strong> ${product.composition}</p>
                            <p><strong>Уход:</strong> ${product.care}</p>
                            <div class="product-images">
                                <h5>Изображения:</h5>
                                ${product.images.map((img, index) => {
                                    if (img && img.trim() !== '' && isValidImageData(img)) {
                                        return `
                                    <div class="product-image-preview">
                                                <img src="${img}" alt="Изображение ${index + 1}" style="max-width: 100px; max-height: 100px; object-fit: cover; border-radius: 4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                                <span style="color: #999; display: none;">Повреждено</span>
                                    </div>
                                        `;
                                    } else {
                                        return `
                                            <div class="product-image-preview">
                                                <span style="color: #999;">Нет изображения</span>
                                            </div>
                                        `;
                                    }
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            productsList.innerHTML = renderProductsList(products);
            
            console.log('Список товаров обновлен');
        }





        // Инициализация товаров при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Админ-панель загружена, начинаем инициализацию...');
            
            try {
                console.log('Инициализация товаров...');
                initProducts();
                console.log('Товары инициализированы');
                
                console.log('Инициализация обработчиков формы...');
                initProductFormHandlers();
                console.log('Обработчики формы инициализированы');
                
                console.log('Инициализация завершена успешно!');
            } catch (error) {
                console.error('Ошибка при инициализации:', error);
                alert('Ошибка при инициализации: ' + error.message);
            }
        });

        // Инициализация обработчиков формы товара
        function initProductFormHandlers() {
            // Обработчики для кнопок размеров
            const sizeButtons = document.querySelectorAll('#sizesContainer .option-btn');
            sizeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    this.classList.toggle('selected');
                    updateHiddenInput('productSizes', '#sizesContainer .option-btn.selected');
                });
            });

            // Обработчики для кнопок цветов
            const colorButtons = document.querySelectorAll('#colorsContainer .option-btn');
            colorButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    this.classList.toggle('selected');
                    updateHiddenInput('productColors', '#colorsContainer .option-btn.selected');
                });
            });

            // Обработчики для категорий
            const categoryCheckboxes = document.querySelectorAll('.category-checkboxes input[type="checkbox"]');
            categoryCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateHiddenInput('productCategory', '.category-checkboxes input[type="checkbox"]:checked');
                });
            });

            // Обработчики для загрузки изображений (4 отдельных блока)
            for (let i = 1; i <= 4; i++) {
                const imageUploadArea = document.getElementById(`imageUploadArea${i}`);
                const imageUpload = document.getElementById(`imageUpload${i}`);

                if (imageUploadArea && imageUpload) {
                    imageUploadArea.addEventListener('click', () => imageUpload.click());
                    
                    imageUpload.addEventListener('change', (e) => {
                        handleSingleImage(e.target.files[0], i);
                    });
                }
            }
        }

        // Обновление скрытого поля
        function updateHiddenInput(inputId, selector) {
            const selectedElements = document.querySelectorAll(selector);
            const values = Array.from(selectedElements).map(element => {
                // Для чекбоксов используем value, для кнопок - data-value
                return element.value || element.dataset.value;
            });
            document.getElementById(inputId).value = values.join(', ');
        }

        // Функция сжатия изображения
        function compressImage(file, maxWidth = 1920, quality = 0.9) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Вычисляем новые размеры
                    let { width, height } = img;
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Рисуем изображение с новыми размерами
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Конвертируем в base64 с сжатием
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                    resolve(compressedDataUrl);
                };
                
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        // Обработка одного изображения - сохраняем как файл с сжатием
        async function handleSingleImage(file, imageIndex) {
            if (file && file.type.startsWith('image/')) {
                try {
                    // Сжимаем изображение
                    const compressedImageUrl = await compressImage(file);
                    
                // Создаем уникальное имя файла
                const timestamp = Date.now() + imageIndex;
                const fileName = `product_${timestamp}_${file.name}`;
                const filePath = `images/${fileName}`;
                
                // Сохраняем информацию о файле
                const imageInfo = {
                    path: filePath,
                    name: fileName,
                    size: file.size,
                    type: file.type,
                        timestamp: timestamp,
                        compressedSize: compressedImageUrl.length
                };
                localStorage.setItem(`image_${timestamp}`, JSON.stringify(imageInfo));
                
                    // Показываем превью сжатого изображения
                    const previewContainer = document.getElementById(`imagePreview${imageIndex}`);
                    previewContainer.innerHTML = `
                        <img src="${compressedImageUrl}" alt="Preview ${imageIndex}" style="width: 100%; height: 100%; object-fit: cover;">
                        <button type="button" class="remove-image" onclick="removeSingleImage(${imageIndex})">×</button>
                    `;
                    
                    // Обновляем скрытое поле
                    updateImagesHiddenInput();
                    
                    console.log(`✅ Изображение ${imageIndex} сжато: ${(file.size/1024/1024).toFixed(2)}MB → ${(compressedImageUrl.length*0.75/1024/1024).toFixed(2)}MB`);
                } catch (error) {
                    console.error('Ошибка при сжатии изображения:', error);
                    alert('Ошибка при обработке изображения: ' + error.message);
                }
            }
        }

        // Удаление одного изображения
        function removeSingleImage(imageIndex) {
            const previewContainer = document.getElementById(`imagePreview${imageIndex}`);
            previewContainer.innerHTML = '';
            
            // Очищаем input файла
            const fileInput = document.getElementById(`imageUpload${imageIndex}`);
            fileInput.value = '';
            
            // Обновляем скрытое поле
            updateImagesHiddenInput();
        }

        // Обновление скрытого поля с изображениями - сохраняем сжатые изображения
        function updateImagesHiddenInput() {
            const hiddenInput = document.getElementById('productImages');
            const images = [];
            
            for (let i = 1; i <= 4; i++) {
                const previewContainer = document.getElementById(`imagePreview${i}`);
                const img = previewContainer.querySelector('img');
                if (img && img.src) {
                    // Сохраняем сжатое изображение напрямую
                    images.push(img.src);
                } else {
                    images.push(''); // Пустая строка для отсутствующего изображения
                }
            }
            // Сохраняем безопасно как JSON, чтобы запятые в data URL не ломали формат
            hiddenInput.value = JSON.stringify(images);
        }

        // Очистка localStorage
        function clearStorage() {
            if (confirm('Вы уверены, что хотите очистить все данные? Это удалит все товары, заказы и статистику!')) {
                try {
                    // Очищаем все товары по отдельности
                    const productIds = JSON.parse(localStorage.getItem('productIds') || '[]');
                    productIds.forEach(id => {
                        localStorage.removeItem(`product_${id}`);
                    });
                    localStorage.removeItem('productIds');
                    
                    // Очищаем старые данные
                    localStorage.removeItem('products');
                    
                    // Очищаем старые изображения
                    clearOldImages();
                    
                    alert('Товары очищены! Теперь можно добавлять новые.');
                    loadProducts();
                } catch (error) {
                    console.error('Ошибка при очистке товаров:', error);
                    alert('Ошибка при очистке товаров: ' + error.message);
                }
            }
        }

        // Очистка старых изображений из localStorage
        function clearOldImages() {
            if (confirm('Очистить старые изображения из localStorage? Это освободит место для новых товаров.')) {
                try {
                    let clearedCount = 0;
                    const keysToRemove = [];
                    
                    // Находим все ключи с изображениями
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('image_')) {
                            keysToRemove.push(key);
                        }
                    }
                    
                    // Удаляем найденные ключи
                    keysToRemove.forEach(key => {
                        localStorage.removeItem(key);
                        clearedCount++;
                    });
                    
                    console.log(`🗑️ Очищено ${clearedCount} старых изображений из localStorage`);
                    alert(`✅ Очищено ${clearedCount} старых изображений! Место освобождено.`);
                    checkStorageSize();
                } catch (error) {
                    console.error('Ошибка при очистке старых изображений:', error);
                    alert('Ошибка при очистке старых изображений: ' + error.message);
                }
            }
        }

        // Проверка размера localStorage
        function checkStorageSize() {
            try {
                let totalSize = 0;
                const storageInfo = {};
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    const size = new Blob([value]).size;
                    totalSize += size;
                    
                    if (key.startsWith('product_')) {
                        storageInfo.products = (storageInfo.products || 0) + size;
                    } else if (key.startsWith('image_')) {
                        storageInfo.images = (storageInfo.images || 0) + size;
                    } else {
                        storageInfo.other = (storageInfo.other || 0) + size;
                    }
                }
                
                const totalMB = (totalSize / 1024 / 1024).toFixed(2);
                const productsMB = ((storageInfo.products || 0) / 1024 / 1024).toFixed(2);
                const imagesMB = ((storageInfo.images || 0) / 1024 / 1024).toFixed(2);
                const otherMB = ((storageInfo.other || 0) / 1024 / 1024).toFixed(2);
                
                console.log(`📊 Размер localStorage: ${totalMB}MB (Товары: ${productsMB}MB, Изображения: ${imagesMB}MB, Остальное: ${otherMB}MB)`);
                
                // Предупреждение если размер превышает 8MB
                if (totalSize > 8 * 1024 * 1024) {
                    console.warn(`⚠️ localStorage почти заполнен: ${totalMB}MB`);
                    alert(`⚠️ Внимание! localStorage почти заполнен (${totalMB}MB). Рекомендуется очистить старые данные.`);
                }
                
                return { totalSize, storageInfo };
            } catch (error) {
                console.error('Ошибка при проверке размера localStorage:', error);
                return null;
            }
        }

        // Валидация изображения (проверка корректности base64)
        function isValidImageData(dataUrl) {
            if (!dataUrl || typeof dataUrl !== 'string') {
                return false;
            }
            
            // Проверяем, что это data URL
            if (!dataUrl.startsWith('data:image/')) {
                return false;
            }
            
            // Проверяем минимальную длину (base64 должен быть достаточно длинным)
            const base64Part = dataUrl.split(',')[1];
            if (!base64Part || base64Part.length < 100) {
                return false;
            }
            
            // Проверяем, что base64 содержит только допустимые символы
            const base64Regex = /^[A-Za-z0-9+/]*={0,2}$/;
            if (!base64Regex.test(base64Part)) {
                return false;
            }
            
            return true;
        }

        // Очистка поврежденных изображений в товарах
        function cleanCorruptedImages() {
            try {
                let cleanedCount = 0;
                const productIds = JSON.parse(localStorage.getItem('productIds') || '[]');
                
                productIds.forEach(productId => {
                    const productKey = `product_${productId}`;
                    const productData = localStorage.getItem(productKey);
                    
                    if (productData) {
                        try {
                            const product = JSON.parse(productData);
                            
                            if (product.images && Array.isArray(product.images)) {
                                const originalLength = product.images.length;
                                product.images = product.images.filter(img => isValidImageData(img));
                                const newLength = product.images.length;
                                
                                if (newLength < originalLength) {
                                    cleanedCount += (originalLength - newLength);
                                    console.log(`🧹 Очищено ${originalLength - newLength} поврежденных изображений в товаре ${productId}`);
                                    
                                    // Сохраняем очищенный товар
                                    localStorage.setItem(productKey, JSON.stringify(product));
                                }
                            }
                        } catch (e) {
                            console.error(`Ошибка при обработке товара ${productId}:`, e);
                        }
                    }
                });
                
                if (cleanedCount > 0) {
                    console.log(`✅ Очищено ${cleanedCount} поврежденных изображений`);
                    alert(`✅ Очищено ${cleanedCount} поврежденных изображений в товарах!`);
                }
                
                return cleanedCount;
            } catch (error) {
                console.error('Ошибка при очистке поврежденных изображений:', error);
                return 0;
            }
        }

        // Функция для очистки только старых данных (для миграции)
        function clearOldData() {
            if (confirm('Очистить старые данные товаров (ключ "products")?')) {
                try {
                    localStorage.removeItem('products');
                    alert('Старые данные очищены!');
                } catch (error) {
                    console.error('Ошибка при очистке старых данных:', error);
                    alert('Ошибка при очистке старых данных: ' + error.message);
                }
            }
        }

        // Обновление списка ID товаров
        function updateProductsList() {
            const productIds = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('product_')) {
                    const id = key.replace('product_', '');
                    productIds.push(parseInt(id));
                }
            }
            localStorage.setItem('productIds', JSON.stringify(productIds));
        }

        // Получение всех товаров
        function getAllProducts() {
            const productIds = JSON.parse(localStorage.getItem('productIds') || '[]');
            const products = [];
            
            productIds.forEach(id => {
                const productData = localStorage.getItem(`product_${id}`);
                if (productData) {
                    try {
                        const product = JSON.parse(productData);
                        
                        // Фильтруем поврежденные изображения
                        if (product.images && Array.isArray(product.images)) {
                            product.images = product.images.filter(img => isValidImageData(img));
                        }
                        
                        products.push(product);
                    } catch (error) {
                        console.error(`Ошибка при загрузке товара ${id}:`, error);
                    }
                }
            });
            
            return products;
        }

        // ===== ФУНКЦИИ УПРАВЛЕНИЯ ОБРАЩЕНИЯМИ =====

        // Глобальные переменные для обращений
        let currentAppealsFilter = 'new';
        let lastViewedAppealId = 0;

        // Загрузка обращений
        function loadAppeals() {
            console.log('Загрузка обращений...');
            
            // Получаем обращения из localStorage
            const appeals = JSON.parse(localStorage.getItem('contactForms') || '[]');
            
            // Разделяем на новые и обработанные
            const newAppeals = appeals.filter(appeal => !appeal.status || appeal.status === 'new');
            const processedAppeals = appeals.filter(appeal => appeal.status === 'processed');
            
            // Обновляем счетчики
            document.getElementById('newCount').textContent = newAppeals.length;
            document.getElementById('processedCount').textContent = processedAppeals.length;
            
            // Отображаем обращения в зависимости от текущего фильтра
            renderAppeals();
            
            // Обновляем уведомления
            updateAppealsNotifications();
            
            console.log(`Загружено обращений: ${appeals.length} (новых: ${newAppeals.length}, обработанных: ${processedAppeals.length})`);
        }

        // Отображение обращений
        function renderAppeals() {
            console.log('renderAppeals вызвана');
            const appeals = JSON.parse(localStorage.getItem('contactForms') || '[]');
            const appealsList = document.getElementById('appealsList');
            
            if (!appealsList) {
                console.error('appealsList не найден');
                return;
            }
            
            // Принудительно применяем стили
            appealsList.style.display = 'flex';
            appealsList.style.flexDirection = 'column';
            appealsList.style.gap = '20px';
            
            // Фильтруем обращения по текущему фильтру
            let filteredAppeals = appeals;
            if (currentAppealsFilter === 'new') {
                filteredAppeals = appeals.filter(appeal => !appeal.status || appeal.status === 'new');
            } else if (currentAppealsFilter === 'processed') {
                filteredAppeals = appeals.filter(appeal => appeal.status === 'processed');
            }
            
            if (filteredAppeals.length === 0) {
                const statusText = currentAppealsFilter === 'new' ? 'Новых обращений пока нет' : 'Обработанных обращений пока нет';
                appealsList.innerHTML = `<div class="no-appeals">${statusText}</div>`;
                return;
            }
            
            // Сортируем по дате (новые сначала)
            filteredAppeals.sort((a, b) => new Date(b.timestamp || b.date) - new Date(a.timestamp || a.date));
            
            appealsList.innerHTML = filteredAppeals.map(appeal => `
                <div class="appeal-item" data-appeal-id="${appeal.id}" style="background: #333; border-radius: 8px; padding: 20px; border-left: 4px solid #007bff; margin-bottom: 20px;">
                    <div class="appeal-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div class="appeal-info" style="flex: 1;">
                            <h4 style="color: #ffffff; margin-bottom: 5px; font-size: 18px;">Обращение #${appeal.id}</h4>
                            <p style="color: #cccccc; margin: 3px 0; font-size: 14px;">От: ${appeal.name} ${appeal.surname}</p>
                            <p style="color: #cccccc; margin: 3px 0; font-size: 14px;">Email: ${appeal.email}</p>
                            <p style="color: #cccccc; margin: 3px 0; font-size: 14px;">Тема: ${appeal.topic}</p>
                            <p style="color: #cccccc; margin: 3px 0; font-size: 14px;">Дата: ${new Date(appeal.timestamp || appeal.date).toLocaleString('ru-RU')}</p>
                        </div>
                        <div class="appeal-status-controls" style="display: flex; flex-direction: column; gap: 10px; align-items: flex-end;">
                            <select class="status-select" onchange="updateAppealStatus(${appeal.id}, this.value)">
                                <option value="new" ${(!appeal.status || appeal.status === 'new') ? 'selected' : ''}>Новые заявки</option>
                                <option value="processed" ${appeal.status === 'processed' ? 'selected' : ''}>Обработан</option>
                            </select>
                        </div>
                    </div>
                    <div class="appeal-message" style="background: #444; border: 1px solid #555; border-radius: 5px; padding: 15px; color: #cccccc; font-size: 14px; line-height: 1.5; margin-top: 15px;">${appeal.message}</div>
                </div>
            `).join('');
        }

        // Фильтрация обращений
        function filterAppeals(filter) {
            currentAppealsFilter = filter;
            
            // Обновляем активную кнопку фильтра
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
            
            // Загружаем отфильтрованные обращения
            renderAppeals();
        }

        // Обновление статуса обращения
        function updateAppealStatus(appealId, newStatus) {
            console.log(`Обновление статуса обращения ${appealId} на ${newStatus}`);
            
            const appeals = JSON.parse(localStorage.getItem('contactForms') || '[]');
            const appealIndex = appeals.findIndex(appeal => appeal.id === appealId);
            
            if (appealIndex !== -1) {
                appeals[appealIndex].status = newStatus;
                appeals[appealIndex].processedDate = newStatus === 'processed' ? new Date().toISOString() : null;
                
                localStorage.setItem('contactForms', JSON.stringify(appeals));
                
                // Перезагружаем обращения
                loadAppeals();
                
                console.log(`Статус обращения ${appealId} обновлен на ${newStatus}`);
            } else {
                console.error(`Обращение с ID ${appealId} не найдено`);
            }
        }

        // Обновление уведомлений о новых обращениях
        function updateAppealsNotifications() {
            const appeals = JSON.parse(localStorage.getItem('contactForms') || '[]');
            const newAppeals = appeals.filter(appeal => !appeal.status || appeal.status === 'new');
            
            const notificationBadge = document.getElementById('appealsNotification');
            
            if (newAppeals.length > 0) {
                // Находим максимальный ID среди новых обращений
                const maxAppealId = Math.max(...newAppeals.map(appeal => appeal.id));
                
                // Показываем уведомление только если есть новые обращения после последнего просмотра
                if (maxAppealId > lastViewedAppealId) {
                    notificationBadge.textContent = newAppeals.length;
                    notificationBadge.style.display = 'inline-block';
                } else {
                    notificationBadge.style.display = 'none';
                }
            } else {
                notificationBadge.style.display = 'none';
            }
        }

        // Скрытие уведомления о обращениях
        function hideAppealsNotification() {
            const notificationBadge = document.getElementById('appealsNotification');
            notificationBadge.style.display = 'none';
            
            // Обновляем последний просмотренный обращение
            const appeals = JSON.parse(localStorage.getItem('contactForms') || '[]');
            if (appeals.length > 0) {
                const maxAppealId = Math.max(...appeals.map(appeal => appeal.id));
                localStorage.setItem('lastViewedAppealId', maxAppealId);
                lastViewedAppealId = maxAppealId;
                console.log(`Уведомление скрыто, последний просмотренный обращение: ${maxAppealId}`);
            }
        }

        // Инициализация уведомлений о обращениях
        function initAppealsNotifications() {
            // Загружаем последний просмотренный ID
            lastViewedAppealId = parseInt(localStorage.getItem('lastViewedAppealId')) || 0;
            
            // Обновляем уведомления
            updateAppealsNotifications();
            
            // Принудительно обновляем стили обращений
            setTimeout(() => {
                const appealsList = document.getElementById('appealsList');
                if (appealsList) {
                    appealsList.style.display = 'flex';
                    appealsList.style.flexDirection = 'column';
                    appealsList.style.gap = '20px';
                }
            }, 100);
            
            // Автоматическое обновление каждые 30 секунд
            setInterval(updateAppealsNotifications, 30000);
        }

        // Инициализация системы обращений при загрузке страницы
        function initAppeals() {
            console.log('Инициализация системы обращений...');
            loadAppeals();
            initAppealsNotifications();
        }

        // ===== СИСТЕМА ОТЧЕТОВ =====
        
        let currentReportsFilter = '1'; // По умолчанию 1 день

        // Загрузка отчетов
        function loadReports() {
            console.log('Загрузка отчетов...');
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            console.log('Всего заказов:', orders.length);
            
            const filteredOrders = filterOrdersByDate(orders, currentReportsFilter);
            console.log('Отфильтрованных заказов:', filteredOrders.length);
            
            renderReportsTable(filteredOrders);
            renderReportsSummary(filteredOrders);
        }

        // Фильтрация заказов по дате
        function filterOrdersByDate(orders, days) {
            const now = new Date();
            const filterDate = new Date(now.getTime() - (days * 24 * 60 * 60 * 1000));
            
            return orders.filter(order => {
                const orderDate = new Date(order.date);
                return orderDate >= filterDate;
            });
        }

        // Фильтрация отчетов
        function filterReports(days) {
            currentReportsFilter = days;
            
            // Обновляем активную кнопку фильтра
            document.querySelectorAll('.reports-filters .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${days}"]`).classList.add('active');
            
            // Загружаем отфильтрованные отчеты
            loadReports();
        }

        // Рендеринг таблицы отчетов
        function renderReportsTable(orders) {
            console.log('🔄 renderReportsTable вызвана с', orders.length, 'заказами');
            console.log('📊 Данные заказов:', orders);
            
            const tbody = document.getElementById('reportsTableBody');
            if (!tbody) {
                console.error('❌ reportsTableBody не найден');
                return;
            }

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px; color: #888;">Нет данных для отображения</td></tr>';
                console.log('ℹ️ Нет данных для отображения');
                return;
            }

            // Получаем артикул: из item.article, иначе из карточки продукта
            function resolveArticle(item) {
                if (item.article) return item.article;
                try {
                    const prodRaw = localStorage.getItem(`product_${item.id}`);
                    if (prodRaw) {
                        const prod = JSON.parse(prodRaw);
                        return prod.article || '';
                    }
                } catch (e) {}
                return '';
            }

            tbody.innerHTML = orders.map((order, orderIndex) => {
                    const customerName = order.userProfile ? 
                        `${order.userProfile.lastName || ''} ${order.userProfile.firstName || ''} ${order.userProfile.middleName || ''}`.trim() : 
                        'Не указано';
                    
                    const customerEmail = order.userEmail || 'Не указано';
                
                // Берем фактическую стоимость доставки из заказа
                    let deliveryCost = (typeof order.shipping === 'number' ? order.shipping : (typeof order.deliveryPrice === 'number' ? order.deliveryPrice : order.deliveryCost));
                    if (typeof deliveryCost !== 'number') {
                        const itemsTotal = order.items.reduce((sum, it) => sum + (it.price * it.quantity), 0);
                        if (typeof order.total === 'number') {
                            const diff = order.total - itemsTotal;
                            deliveryCost = diff > 0 ? diff : 0;
                        } else {
                            deliveryCost = 0;
                        }
                    }
                
                // Расчет скидки и итоговой цены
                const itemsTotal = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                let discount = 0;
                let discountText = 'Нет';
                
                // Рассчитываем скидки на товары
                let productDiscounts = 0;
                const productDiscountItems = [];
                
                order.items.forEach(item => {
                    const discounts = JSON.parse(localStorage.getItem('discounts') || '[]');
                    const activeDiscount = discounts.find(discount => 
                        discount.productId === item.id.toString() && 
                        new Date(discount.startDate) <= new Date(order.date) && 
                        new Date(discount.endDate) >= new Date(order.date)
                    );
                    
                    if (activeDiscount) {
                        let itemDiscount = 0;
                        if (activeDiscount.type === 'percentage') {
                            itemDiscount = Math.round(item.price * (activeDiscount.value / 100) * item.quantity);
                        } else {
                            itemDiscount = Math.min(activeDiscount.value * item.quantity, item.price * item.quantity);
                        }
                        productDiscounts += itemDiscount;
                        productDiscountItems.push(`${item.name} (-${itemDiscount.toLocaleString()} ₽)`);
                    }
                });
                
                // Если есть промокод, добавляем его скидку
                if (order.promoCode && order.discount !== undefined) {
                    discount += order.discount;
                    if (order.discountType === 'percent') {
                        discountText = `${order.promoCode} (-${order.discount}%)`;
                    } else {
                        discountText = `${order.promoCode} (-${order.discount.toLocaleString()} ₽)`;
                    }
                } else if (order.promoCode) {
                    // Если промокод есть, но скидка не указана, показываем только код
                    discountText = order.promoCode;
                }
                
                // Добавляем скидки на товары к общей скидке
                discount += productDiscounts;
                
                // Обновляем текст скидки, если есть скидки на товары
                if (productDiscountItems.length > 0) {
                    if (discountText === 'Нет') {
                        discountText = productDiscountItems.join(', ');
                    } else {
                        discountText += ', ' + productDiscountItems.join(', ');
                    }
                }
                
                // Итоговая цена с учетом всех скидок (как в корзине)
                const totalOrderPrice = itemsTotal + deliveryCost - discount;
                
                // Общее количество товаров в заказе
                const totalQuantity = order.items.reduce((sum, item) => sum + item.quantity, 0);
                
                // Список всех товаров в заказе
                const itemsList = order.items.map(item => {
                    const article = resolveArticle(item) || 'Не указан';
                    return `${item.name} (${article}) - ${item.quantity} шт.`;
                }).join('<br>');

                    return `
                        <tr>
                            <td>${new Date(order.date).toLocaleDateString('ru-RU')}</td>
                        <td>${itemsList}</td>
                        <td>${totalQuantity}</td>
                            <td>${customerName}<br><small class="small">${customerEmail}</small></td>
                            <td class="num">${deliveryCost.toLocaleString('ru-RU')} ₽</td>
                        <td>${discountText}</td>
                        <td class="num">${totalOrderPrice.toLocaleString('ru-RU')} ₽</td>
                        </tr>
                    `;
                }).join('');
            
            console.log('✅ Таблица отчетов обновлена');
            console.log('📋 Сгенерированный HTML:', tbody.innerHTML.substring(0, 500) + '...');
        }

        // Рендеринг сводки отчетов
        function renderReportsSummary(orders) {
            const summary = document.getElementById('reportsSummary');
            if (!summary) return;

            const totalOrders = orders.length;
            const totalItems = orders.reduce((sum, order) => sum + order.items.length, 0);
            const totalRevenue = orders.reduce((sum, order) => {
                const itemsTotal = order.items.reduce((itemSum, item) => itemSum + (item.price * item.quantity), 0);
                let deliveryCost = (typeof order.shipping === 'number' ? order.shipping : (typeof order.deliveryPrice === 'number' ? order.deliveryPrice : order.deliveryCost));
                if (typeof deliveryCost !== 'number') {
                    if (typeof order.total === 'number') {
                        const diff = order.total - itemsTotal;
                        deliveryCost = diff > 0 ? diff : 0;
                    } else {
                        deliveryCost = 0;
                    }
                }
                
                // Рассчитываем скидки на товары
                let productDiscounts = 0;
                order.items.forEach(item => {
                    const discounts = JSON.parse(localStorage.getItem('discounts') || '[]');
                    const activeDiscount = discounts.find(discount => 
                        discount.productId === item.id.toString() && 
                        new Date(discount.startDate) <= new Date(order.date) && 
                        new Date(discount.endDate) >= new Date(order.date)
                    );
                    
                    if (activeDiscount) {
                        if (activeDiscount.type === 'percentage') {
                            productDiscounts += Math.round(item.price * (activeDiscount.value / 100) * item.quantity);
                        } else {
                            productDiscounts += Math.min(activeDiscount.value * item.quantity, item.price * item.quantity);
                        }
                    }
                });
                
                // Учитываем все скидки в итоговой сумме (промокод + скидки на товары)
                const promoDiscount = order.discount || 0;
                const totalDiscount = promoDiscount + productDiscounts;
                return sum + itemsTotal + deliveryCost - totalDiscount;
            }, 0);

            summary.innerHTML = `
                <h4>Сводка по продажам</h4>
                <div class="summary-stats">
                    <div class="summary-stat">
                        <div class="summary-stat-value">${totalOrders}</div>
                        <div class="summary-stat-label">Всего заказов</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value">${totalItems}</div>
                        <div class="summary-stat-label">Всего товаров</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value">${totalRevenue.toLocaleString()} ₽</div>
                        <div class="summary-stat-label">Итоговая сумма продаж</div>
                    </div>
                </div>
            `;
        }

        // Экспорт в HTML с возможностью печати
        function exportToExcel() {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const filteredOrders = filterOrdersByDate(orders, currentReportsFilter);
            
            if (filteredOrders.length === 0) {
                alert('Нет данных для экспорта');
                return;
            }

            // Подготавливаем данные для Excel
            const excelData = [];
            
            // Заголовки
            excelData.push([
                'Дата продажи',
                'Товары в заказе',
                'Количество',
                'ФИО покупателя',
                'Email покупателя',
                'Доставка (₽)',
                'Промокод',
                'Итоговая цена (₽)'
            ]);

            // Данные
            filteredOrders.forEach(order => {
                    const customerName = order.userProfile ? 
                        `${order.userProfile.lastName || ''} ${order.userProfile.firstName || ''} ${order.userProfile.middleName || ''}`.trim() : 
                        'Не указано';
                    
                    const customerEmail = order.userEmail || 'Не указано';
                    const deliveryCost = (typeof order.shipping === 'number' ? order.shipping : (typeof order.deliveryPrice === 'number' ? order.deliveryPrice : order.deliveryCost)) || 0;
                
                // Расчет скидки и итоговой цены
                const itemsTotal = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                let discount = 0;
                let discountText = 'Нет';
                
                // Рассчитываем скидки на товары
                let productDiscounts = 0;
                const productDiscountItems = [];
                
                order.items.forEach(item => {
                    const discounts = JSON.parse(localStorage.getItem('discounts') || '[]');
                    const activeDiscount = discounts.find(discount => 
                        discount.productId === item.id.toString() && 
                        new Date(discount.startDate) <= new Date(order.date) && 
                        new Date(discount.endDate) >= new Date(order.date)
                    );
                    
                    if (activeDiscount) {
                        let itemDiscount = 0;
                        if (activeDiscount.type === 'percentage') {
                            itemDiscount = Math.round(item.price * (activeDiscount.value / 100) * item.quantity);
                        } else {
                            itemDiscount = Math.min(activeDiscount.value * item.quantity, item.price * item.quantity);
                        }
                        productDiscounts += itemDiscount;
                        productDiscountItems.push(`${item.name} (-${itemDiscount.toLocaleString()} ₽)`);
                    }
                });
                
                // Если есть промокод, добавляем его скидку
                if (order.promoCode && order.discount !== undefined) {
                    discount += order.discount;
                    if (order.discountType === 'percent') {
                        discountText = `${order.promoCode} (-${order.discount}%)`;
                    } else {
                        discountText = `${order.promoCode} (-${order.discount.toLocaleString()} ₽)`;
                    }
                } else if (order.promoCode) {
                    // Если промокод есть, но скидка не указана, показываем только код
                    discountText = order.promoCode;
                }
                
                // Добавляем скидки на товары к общей скидке
                discount += productDiscounts;
                
                // Обновляем текст скидки, если есть скидки на товары
                if (productDiscountItems.length > 0) {
                    if (discountText === 'Нет') {
                        discountText = productDiscountItems.join(', ');
                    } else {
                        discountText += ', ' + productDiscountItems.join(', ');
                    }
                }
                
                // Итоговая цена с учетом всех скидок (как в корзине)
                const totalOrderPrice = itemsTotal + deliveryCost - discount;
                
                // Общее количество товаров в заказе
                const totalQuantity = order.items.reduce((sum, item) => sum + item.quantity, 0);
                
                // Список всех товаров в заказе
                const itemsList = order.items.map(item => {
                    // Получаем артикул: из item.article, иначе из карточки продукта
                    let article = item.article || '';
                    if (!article) {
                        try {
                            const prodRaw = localStorage.getItem(`product_${item.id}`);
                            if (prodRaw) {
                                const prod = JSON.parse(prodRaw);
                                article = prod.article || '';
                            }
                        } catch (e) {}
                    }
                    if (!article) article = 'Не указан';
                    
                    return `${item.name} (${article}) - ${item.quantity} шт.`;
                }).join('; ');

                    excelData.push([
                        new Date(order.date).toLocaleDateString('ru-RU'),
                    itemsList,
                    totalQuantity,
                        customerName,
                        customerEmail,
                        deliveryCost,
                    discountText,
                    totalOrderPrice
                    ]);
                });

            // Создаем HTML таблицу с форматированием для Excel
            const currentDate = new Date().toLocaleDateString('ru-RU').replace(/\./g, '-');
            const fileName = `отчет_по_продажам_${currentDate}.html`;
            
            // Создаем HTML с CSS стилями для Excel
            const htmlContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Отчет по продажам</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
            background: #ffffff;
        }
        
        .print-controls {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .print-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 0 10px;
            transition: background 0.3s;
        }
        
        .print-btn:hover {
            background: #0056b3;
        }
        
        .print-btn.secondary {
            background: #6c757d;
        }
        
        .print-btn.secondary:hover {
            background: #545b62;
        }
        
        .report-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .report-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .report-date {
            font-size: 16px;
            color: #666;
        }
        
        .summary-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #e9ecef;
            border-radius: 8px;
        }
        
        .summary-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        
        .summary-stats {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .summary-stat {
            text-align: center;
            min-width: 120px;
        }
        
        .summary-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 5px;
        }
        
        .summary-stat-label {
            font-size: 14px;
            color: #666;
        }
        
        .table-container {
            overflow-x: auto;
            margin-bottom: 30px;
        }
        
        .reports-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            background: #ffffff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .reports-table th {
            background: #495057;
            color: #ffffff;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #6c757d;
            white-space: nowrap;
        }
        
        .reports-table td {
            padding: 12px;
            border: 1px solid #dee2e6;
            color: #333;
            vertical-align: top;
            background: #ffffff;
            word-wrap: break-word;
            white-space: normal;
        }
        
        .reports-table tbody tr:nth-child(even) td {
            background: #f8f9fa;
        }
        
        .reports-table tbody tr:hover td {
            background: #e9ecef;
        }
        
        .reports-table td.num, .reports-table th.num {
            text-align: right;
            white-space: nowrap;
        }
        
        .reports-table td.small {
            color: #6c757d;
            font-size: 12px;
        }
        
        .date-cell {
            font-weight: 500;
            color: #495057;
        }
        
        .price-cell {
            font-weight: 600;
            color: #28a745;
        }
        
        .discount-cell {
            color: #dc3545;
            font-weight: 500;
        }
        
        .footer {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
            color: #666;
            font-size: 14px;
        }

        /* ===== СТИЛИ ДЛЯ РАЗДЕЛА КОНТЕНТА ===== */
        .content-container {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 20px;
        }

        .content-header {
            margin-bottom: 30px;
            text-align: center;
        }

        .content-header p {
            color: #cccccc;
            font-size: 16px;
            margin-top: 10px;
        }

        .content-filters {
            display: flex !important;
            gap: 10px !important;
            margin-bottom: 80px !important;
            flex-wrap: nowrap !important;
            align-items: center !important;
            justify-content: center !important;
            overflow-x: auto !important;
            padding: 10px 0 !important;
        }

        .content-filters .filter-btn {
            background: #2a2a2a !important;
            border: 2px solid #444 !important;
            color: #ffffff !important;
            padding: 12px 15px !important;
            border-radius: 8px !important;
            cursor: pointer !important;
            font-size: 12px !important;
            font-weight: bold !important;
            transition: all 0.3s ease !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
            min-width: 120px !important;
            text-align: center !important;
            white-space: nowrap !important;
            flex-shrink: 0 !important;
        }

        .content-filters .filter-btn:hover {
            background: #333 !important;
            border-color: #666 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3) !important;
        }

        .content-filters .filter-btn.active {
            background: #000000 !important;
            border-color: #ffffff !important;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3) !important;
        }

        .content-filters .filter-btn:hover {
            background: #333 !important;
            border-color: #666 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3) !important;
        }

        .content-section {
            background: #333 !important;
            border-radius: 12px !important;
            padding: 40px !important;
            border-left: 4px solid #007bff !important;
            margin-top: 50px !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
        }

        .content-buttons {
            display: flex !important;
            flex-direction: column !important;
            gap: 15px !important;
            margin-top: 50px !important;
            align-items: center !important;
            max-width: 400px !important;
            margin-left: auto !important;
            margin-right: auto !important;
        }

        .content-btn {
            background: #2a2a2a !important;
            color: #ffffff !important;
            border: 2px solid #444 !important;
            padding: 30px 20px !important;
            border-radius: 10px !important;
            cursor: pointer !important;
            font-size: 18px !important;
            font-weight: bold !important;
            transition: all 0.3s ease !important;
            text-transform: uppercase !important;
            letter-spacing: 1px !important;
            min-height: 80px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
            width: 100% !important;
            margin-bottom: 15px !important;
        }

        .content-btn:hover {
            background: #333 !important;
            border-color: #666 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3) !important;
        }

        .content-btn:active {
            transform: translateY(0) !important;
        }

        /* Адаптивность для мобильных устройств */
        @media (max-width: 768px) {
            .content-sections {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .content-section {
                padding: 15px !important;
            }

            .content-btn {
                padding: 20px 25px !important;
                font-size: 16px !important;
                min-height: 60px !important;
            }
        }

        /* ===== СТИЛИ ДЛЯ МОДАЛЬНОГО ОКНА КОНТЕНТА ===== */
        .content-modal {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            background: rgba(0, 0, 0, 0.8) !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            z-index: 999999 !important;
            animation: contentModalFadeIn 0.3s ease !important;
        }

        .content-modal .modal-content {
            background: white !important;
            border-radius: 10px !important;
            width: 90% !important;
            max-width: 600px !important;
            max-height: 85vh !important;
            overflow-y: auto !important;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3) !important;
            animation: contentModalSlideIn 0.3s ease !important;
            position: relative !important;
            top: 0 !important;
            transform: none !important;
            padding: 0 !important;
        }

        @keyframes contentModalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes contentModalSlideIn {
            from { 
                opacity: 0; 
                transform: scale(0.9) translateY(-20px); 
            }
            to { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }

        .content-modal .modal-header {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            padding: 30px 30px 20px 30px !important;
            border-bottom: 1px solid #e0e0e0 !important;
        }

        .content-modal .modal-header h3 {
            color: #000000 !important;
            margin: 0 !important;
            font-size: 24px !important;
            font-weight: bold !important;
        }

        .content-modal .modal-close {
            background: none !important;
            border: none !important;
            color: #000000 !important;
            font-size: 28px !important;
            cursor: pointer !important;
            padding: 0 !important;
            width: 35px !important;
            height: 35px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 50% !important;
            transition: background 0.3s !important;
        }

        .content-modal .modal-close:hover {
            background: #f0f0f0 !important;
        }

        .content-modal .modal-body {
            padding: 30px !important;
        }

        .content-modal .content-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }

        .content-modal .content-info p {
            color: #000000;
            margin: 5px 0;
            font-size: 14px;
        }

        /* Удалены дублирующиеся стили - новые стили находятся ниже */

        .content-modal .image-upload-area {
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
            margin-bottom: 15px;
        }

        .content-modal .image-upload-area:hover {
            border-color: #000000;
            background: #f0f0f0;
        }

        .content-modal .upload-placeholder {
            color: #000000;
        }

        .content-modal .upload-icon {
            font-size: 48px;
            display: block;
            margin-bottom: 10px;
        }

        .content-modal .image-preview {
            position: relative;
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden;
            min-height: 100px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
        }

        .content-modal .image-preview img {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
        }

        .content-modal .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .content-modal .content-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .content-modal .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .content-modal .form-group label {
            color: #000000;
            font-weight: 500;
            font-size: 14px;
        }

        .content-modal .form-group input,
        .content-modal .form-group textarea {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            color: #000000;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .content-modal .form-group input:focus,
        .content-modal .form-group textarea:focus {
            outline: none;
            border-color: #000000;
        }

        .content-modal .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .content-modal .modal-footer {
            display: flex !important;
            justify-content: center !important;
            gap: 15px !important;
            padding: 20px 30px 30px 30px !important;
            border-top: 1px solid #e0e0e0 !important;
        }

        .content-modal .btn-primary,
        .content-modal .btn-secondary {
            padding: 12px 24px !important;
            border: none !important;
            border-radius: 5px !important;
            font-size: 16px !important;
            font-weight: 500 !important;
            cursor: pointer !important;
            transition: all 0.3s !important;
            text-transform: none !important;
            letter-spacing: normal !important;
        }

        .content-modal .btn-primary {
            background: #000000 !important;
            color: #ffffff !important;
        }

        .content-modal .btn-primary:hover {
            background: #333333 !important;
            transform: none !important;
            box-shadow: none !important;
        }

        .content-modal .btn-secondary {
            background: #ffffff !important;
            color: #000000 !important;
            border: 1px solid #000000 !important;
        }

        .content-modal .btn-secondary:hover {
            background: #f8f9fa !important;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Анимации для модального окна контента уже определены выше */

        /* Адаптивность модального окна */
        @media (max-width: 768px) {
            .content-modal .modal-content {
                width: 95%;
                margin: 10px;
            }

            .content-modal .modal-header,
            .content-modal .modal-body,
            .content-modal .modal-footer {
                padding: 15px;
            }

            .content-modal .modal-footer {
                flex-direction: column;
            }

            .content-modal .btn-primary,
            .content-modal .btn-secondary {
                width: 100%;
            }
        }
        
        /* Стили для печати */
        @media print {
            body {
                margin: 0;
                padding: 15px;
                background: white;
            }
            
            .print-controls {
                display: none !important;
            }
            
            .report-header {
                background: white !important;
                border: 2px solid #333;
                margin-bottom: 20px;
            }
            
            .summary-section {
                background: #f0f0f0 !important;
                border: 1px solid #ccc;
                margin-bottom: 20px;
            }
            
            .reports-table {
                box-shadow: none;
                border: 2px solid #333;
            }
            
            .reports-table th {
                background: #333 !important;
                color: white !important;
                border: 1px solid #000;
            }
            
            .reports-table td {
                border: 1px solid #000;
                background: white !important;
            }
            
            .reports-table tbody tr:nth-child(even) td {
                background: #f9f9f9 !important;
            }
            
            .reports-table tbody tr:hover td {
                background: white !important;
            }
            
            .footer {
                background: white !important;
                border: 1px solid #ccc;
                margin-top: 20px;
            }
            
            .price-cell {
                color: #000 !important;
                font-weight: bold;
            }
            
            .discount-cell {
                color: #000 !important;
                font-weight: bold;
            }
            
            .date-cell {
                color: #000 !important;
                font-weight: bold;
            }
            
            /* Разрывы страниц */
            .reports-table {
                page-break-inside: auto;
            }
            
            .reports-table tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            
            .reports-table thead {
                display: table-header-group;
            }
            
            .reports-table tfoot {
                display: table-footer-group;
            }
        }
    </style>
</head>
<body>
    <div class="print-controls">
        <button class="print-btn" onclick="window.print()">🖨️ Печать отчета</button>
        <button class="print-btn secondary" onclick="window.close()">❌ Закрыть</button>
        <button class="print-btn secondary" onclick="window.history.back()">⬅️ Назад</button>
    </div>
    
    <div class="report-header">
        <div class="report-title">Отчет по продажам</div>
        <div class="report-date">Период: ${getFilterPeriodText()}</div>
    </div>
    
    <div class="summary-section">
        <div class="summary-title">Сводка по продажам</div>
        <div class="summary-stats">
            <div class="summary-stat">
                <div class="summary-stat-value">${filteredOrders.length}</div>
                <div class="summary-stat-label">Всего заказов</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-value">${filteredOrders.reduce((sum, order) => sum + order.items.reduce((itemSum, item) => itemSum + item.quantity, 0), 0)}</div>
                <div class="summary-stat-label">Всего товаров</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-value">${filteredOrders.reduce((sum, order) => {
                    const itemsTotal = order.items.reduce((itemSum, item) => itemSum + (item.price * item.quantity), 0);
                    let deliveryCost = (typeof order.shipping === 'number' ? order.shipping : (typeof order.deliveryPrice === 'number' ? order.deliveryPrice : order.deliveryCost)) || 0;
                    const discount = order.discount || 0;
                    return sum + itemsTotal + deliveryCost - discount;
                }, 0).toLocaleString()} ₽</div>
                <div class="summary-stat-label">Итоговая сумма продаж</div>
            </div>
        </div>
    </div>
    
    <div class="table-container">
        <table class="reports-table">
            <thead>
                <tr>
                    <th>Дата продажи</th>
                    <th>Товары в заказе</th>
                    <th>Количество</th>
                    <th>Покупатель</th>
                    <th class="num">Доставка (₽)</th>
                    <th>Промокод</th>
                    <th class="num">Итоговая цена (₽)</th>
                </tr>
            </thead>
            <tbody>
                ${filteredOrders.map(order => {
                    const customerName = order.userProfile ? 
                        `${order.userProfile.lastName || ''} ${order.userProfile.firstName || ''} ${order.userProfile.middleName || ''}`.trim() : 
                        'Не указано';
                    
                    const customerEmail = order.userEmail || 'Не указано';
                    const deliveryCost = (typeof order.shipping === 'number' ? order.shipping : (typeof order.deliveryPrice === 'number' ? order.deliveryPrice : order.deliveryCost)) || 0;
                    
                    // Расчет скидки и итоговой цены
                    const itemsTotal = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    let discount = 0;
                    let discountText = 'Нет';
                    
                    // Если есть промокод, рассчитываем скидку
                    if (order.promoCode && order.discount !== undefined) {
                        discount = order.discount;
                        if (order.discountType === 'percent') {
                            discountText = `${order.promoCode} (-${order.discount}%)`;
                        } else {
                            discountText = `${order.promoCode} (-${order.discount.toLocaleString()} ₽)`;
                        }
                    } else if (order.promoCode) {
                        discountText = order.promoCode;
                    }
                    
                    // Итоговая цена с учетом скидки
                    const totalOrderPrice = itemsTotal + deliveryCost - discount;
                    
                    // Общее количество товаров в заказе
                    const totalQuantity = order.items.reduce((sum, item) => sum + item.quantity, 0);
                    
                    // Список всех товаров в заказе
                    const itemsList = order.items.map(item => {
                        let article = item.article || '';
                        if (!article) {
                            try {
                                const prodRaw = localStorage.getItem(`product_${item.id}`);
                                if (prodRaw) {
                                    const prod = JSON.parse(prodRaw);
                                    article = prod.article || '';
                                }
                            } catch (e) {}
                        }
                        if (!article) article = 'Не указан';
                        
                        return `${item.name} (${article}) - ${item.quantity} шт.`;
                    }).join('<br>');

                    return `
                        <tr>
                            <td class="date-cell">${new Date(order.date).toLocaleDateString('ru-RU')}</td>
                            <td>${itemsList}</td>
                            <td>${totalQuantity}</td>
                            <td>${customerName}<br><small class="small">${customerEmail}</small></td>
                            <td class="num">${deliveryCost.toLocaleString('ru-RU')} ₽</td>
                            <td class="discount-cell">${discountText}</td>
                            <td class="num price-cell">${totalOrderPrice.toLocaleString('ru-RU')} ₽</td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
    </div>
    
    <div class="footer">
        <p>Отчет сгенерирован: ${new Date().toLocaleString('ru-RU')}</p>
        <p>Центр Кино™ - Система управления продажами</p>
    </div>
</body>
</html>`;

            // Создаем и скачиваем файл
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Функция для получения текста периода фильтра
        function getFilterPeriodText() {
            const periods = {
                '1': '1 день',
                '7': 'Неделя',
                '30': 'Месяц',
                '365': 'Год'
            };
            return periods[currentReportsFilter] || 'Все время';
        }

        // Экспорт в Excel формат (исправленная версия)
        function exportToExcelFormat() {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const filteredOrders = filterOrdersByDate(orders, currentReportsFilter);
            
            if (filteredOrders.length === 0) {
                alert('Нет данных для экспорта');
                return;
            }

            // Подготавливаем данные для Excel с правильной кодировкой
            const excelData = [];
            
            // Заголовки
            excelData.push([
                'Дата продажи',
                'Товары в заказе',
                'Количество',
                'ФИО покупателя',
                'Email покупателя',
                'Доставка (₽)',
                'Промокод',
                'Итоговая цена (₽)'
            ]);

            // Данные
            filteredOrders.forEach(order => {
                const customerName = order.userProfile ? 
                    `${order.userProfile.lastName || ''} ${order.userProfile.firstName || ''} ${order.userProfile.middleName || ''}`.trim() : 
                    'Не указано';
                
                const customerEmail = order.userEmail || 'Не указано';
                const deliveryCost = (typeof order.shipping === 'number' ? order.shipping : (typeof order.deliveryPrice === 'number' ? order.deliveryPrice : order.deliveryCost)) || 0;
                
                // Расчет скидки и итоговой цены (как в HTML версии)
                const itemsTotal = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                let discount = 0;
                let discountText = 'Нет';
                
                // Рассчитываем скидки на товары
                let productDiscounts = 0;
                const productDiscountItems = [];
                
                order.items.forEach(item => {
                    const discounts = JSON.parse(localStorage.getItem('discounts') || '[]');
                    const activeDiscount = discounts.find(discount => 
                        discount.productId === item.id.toString() && 
                        new Date(discount.startDate) <= new Date(order.date) && 
                        new Date(discount.endDate) >= new Date(order.date)
                    );
                    
                    if (activeDiscount) {
                        let itemDiscount = 0;
                        if (activeDiscount.type === 'percentage') {
                            itemDiscount = Math.round(item.price * (activeDiscount.value / 100) * item.quantity);
                        } else {
                            itemDiscount = Math.min(activeDiscount.value * item.quantity, item.price * item.quantity);
                        }
                        productDiscounts += itemDiscount;
                        productDiscountItems.push(`${item.name} (-${itemDiscount.toLocaleString()} ₽)`);
                    }
                });
                
                // Если есть промокод, добавляем его скидку
                if (order.promoCode && order.discount !== undefined) {
                    discount += order.discount;
                    if (order.discountType === 'percent') {
                        discountText = `${order.promoCode} (-${order.discount}%)`;
                    } else {
                        discountText = `${order.promoCode} (-${order.discount.toLocaleString()} ₽)`;
                    }
                } else if (order.promoCode) {
                    discountText = order.promoCode;
                }
                
                // Добавляем скидки на товары к общей скидке
                discount += productDiscounts;
                
                // Обновляем текст скидки, если есть скидки на товары
                if (productDiscountItems.length > 0) {
                    if (discountText === 'Нет') {
                        discountText = productDiscountItems.join(', ');
                    } else {
                        discountText += ', ' + productDiscountItems.join(', ');
                    }
                }
                
                // Итоговая цена с учетом всех скидок
                const totalOrderPrice = itemsTotal + deliveryCost - discount;
                
                // Общее количество товаров в заказе
                const totalQuantity = order.items.reduce((sum, item) => sum + item.quantity, 0);
                
                // Список всех товаров в заказе
                const itemsList = order.items.map(item => {
                    let article = item.article || '';
                    if (!article) {
                        try {
                            const prodRaw = localStorage.getItem(`product_${item.id}`);
                            if (prodRaw) {
                                const prod = JSON.parse(prodRaw);
                                article = prod.article || '';
                            }
                        } catch (e) {}
                    }
                    if (!article) article = 'Не указан';
                    
                    return `${item.name} (${article}) - ${item.quantity} шт.`;
                }).join('; ');

                // Форматируем дату для Excel (DD.MM.YYYY)
                const orderDate = new Date(order.date);
                const formattedDate = `${orderDate.getDate().toString().padStart(2, '0')}.${(orderDate.getMonth() + 1).toString().padStart(2, '0')}.${orderDate.getFullYear()}`;

                excelData.push([
                    formattedDate,
                    itemsList,
                    totalQuantity,
                    customerName,
                    customerEmail,
                    deliveryCost,
                    discountText,
                    totalOrderPrice
                ]);
            });

            // Создаем XLSX файл с правильной кодировкой
            const currentDate = new Date().toLocaleDateString('ru-RU').replace(/\./g, '-');
            const fileName = `отчет_по_продажам_${currentDate}.xls`;
            
            // Рассчитываем сводку
            const totalOrders = filteredOrders.length;
            const totalItems = filteredOrders.reduce((sum, order) => sum + order.items.reduce((itemSum, item) => itemSum + item.quantity, 0), 0);
            const totalRevenue = filteredOrders.reduce((sum, order) => {
                const itemsTotal = order.items.reduce((itemSum, item) => itemSum + (item.price * item.quantity), 0);
                let deliveryCost = (typeof order.shipping === 'number' ? order.shipping : (typeof order.deliveryPrice === 'number' ? order.deliveryPrice : order.deliveryCost)) || 0;
                const discount = order.discount || 0;
                return sum + itemsTotal + deliveryCost - discount;
            }, 0);

            // Создаем HTML таблицу для Excel с правильным форматированием
            const htmlContent = `
<!DOCTYPE html>
<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Отчет по продажам</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            font-family: Arial, sans-serif;
            font-size: 12px;
            margin-bottom: 20px;
        }
        th {
            background-color: #4472C4;
            color: white;
            font-weight: bold;
            text-align: center;
            padding: 8px;
            border: 1px solid #000000;
        }
        td {
            padding: 6px;
            border: 1px solid #000000;
            text-align: left;
            vertical-align: top;
        }
        .number {
            text-align: right;
            mso-number-format: "#,##0";
        }
        .date {
            text-align: center;
            mso-number-format: "dd.mm.yyyy";
        }
        .currency {
            text-align: right;
            mso-number-format: "#,##0 ₽";
        }
        .summary-table {
            margin-bottom: 30px;
        }
        .summary-table th {
            background-color: #28a745;
            font-size: 14px;
            padding: 10px;
        }
        .summary-table td {
            font-size: 14px;
            padding: 10px;
            font-weight: bold;
        }
        .summary-value {
            text-align: center;
            font-size: 16px;
            color: #28a745;
        }
        .summary-label {
            text-align: center;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- Сводка по продажам -->
    <table class="summary-table">
        <thead>
            <tr>
                <th colspan="3">СВОДКА ПО ПРОДАЖАМ</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td class="summary-label">Всего заказов</td>
                <td class="summary-label">Всего товаров</td>
                <td class="summary-label">Итоговая сумма продаж</td>
            </tr>
            <tr>
                <td class="summary-value">${totalOrders}</td>
                <td class="summary-value">${totalItems}</td>
                <td class="summary-value">${totalRevenue.toLocaleString()} ₽</td>
            </tr>
        </tbody>
    </table>

    <!-- Детальная таблица заказов -->
    <table>
        <thead>
            <tr>
                <th>Дата продажи</th>
                <th>Товары в заказе</th>
                <th>Количество</th>
                <th>ФИО покупателя</th>
                <th>Email покупателя</th>
                <th>Доставка (₽)</th>
                <th>Промокод</th>
                <th>Итоговая цена (₽)</th>
            </tr>
        </thead>
        <tbody>
            ${excelData.slice(1).map(row => `
                <tr>
                    <td class="date">${row[0]}</td>
                    <td>${row[1]}</td>
                    <td class="number">${row[2]}</td>
                    <td>${row[3]}</td>
                    <td>${row[4]}</td>
                    <td class="currency">${row[5]}</td>
                    <td>${row[6]}</td>
                    <td class="currency">${row[7]}</td>
                </tr>
            `).join('')}
        </tbody>
    </table>
</body>
</html>`;

            // Создаем и скачиваем файл
            const blob = new Blob([htmlContent], { type: 'application/vnd.ms-excel;charset=utf-8' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Инициализация системы отчетов
        function initReports() {
            console.log('Инициализация системы отчетов...');
            loadReports();
        }

        // ===== ФУНКЦИИ УПРАВЛЕНИЯ КОНТЕНТОМ =====

        // Открытие модального окна для редактирования контента
        function openContentModal(page, element) {
            console.log(`Открытие модального окна для: ${page} - ${element}`);
            
            // Удаляем старое модальное окно если есть
            const oldModal = document.getElementById('contentModal');
            if (oldModal) {
                oldModal.remove();
            }
            
            // Проверяем, является ли это товаром в новых поступлениях
            const isNewArrivalsProduct = page === 'new-arrivals' && element.startsWith('product');
            
            // Определяем, нужно ли показывать поля заголовка и описания
            const showTextFields = !(page === 'about' || page === 'help');
            
            let modalHTML;
            
            if (isNewArrivalsProduct) {
                // Специальное модальное окно для выбора товаров
                modalHTML = `
                    <div class="content-modal" id="contentModal" style="position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important; background: rgba(0, 0, 0, 0.8) !important; display: flex !important; justify-content: center !important; align-items: center !important; z-index: 999999 !important;">
                        <div class="modal-content" style="background: white !important; border-radius: 10px !important; width: 90% !important; max-width: 600px !important; max-height: 85vh !important; overflow-y: auto !important; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3) !important; padding: 0 !important;">
                            <div class="modal-header" style="display: flex !important; justify-content: space-between !important; align-items: center !important; padding: 30px 30px 20px 30px !important; border-bottom: 1px solid #e0e0e0 !important;">
                                <h3 style="color: #000000 !important; margin: 0 !important; font-size: 24px !important; font-weight: bold !important;">Выбор товара</h3>
                                <button class="modal-close" onclick="closeContentModal()" style="background: none !important; border: none !important; color: #000000 !important; font-size: 28px !important; cursor: pointer !important; padding: 0 !important; width: 35px !important; height: 35px !important; display: flex !important; align-items: center !important; justify-content: center !important; border-radius: 50% !important;">×</button>
                            </div>
                            <div class="modal-body" style="padding: 30px !important;">
                                <div class="content-info" style="background: #f8f9fa; border: 1px solid #e0e0e0; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                                    <p style="color: #000000; font-size: 14px; margin: 5px 0;"><strong>Страница:</strong> ${getPageName(page)}</p>
                                    <p style="color: #000000; font-size: 14px; margin: 5px 0;"><strong>Элемент:</strong> ${getElementName(element)}</p>
                                </div>
                                <div class="content-form">
                                    <div class="form-group" style="margin-bottom: 20px;">
                                        <label style="color: #000000; font-weight: bold; display: block; margin-bottom: 10px;">1. ВЫБОР ТОВАРА:</label>
                                        <select id="productSelect" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 5px; font-size: 16px; background: #ffffff; color: #000000; margin-bottom: 15px;">
                                            <option value="">Выберите товар из списка</option>
                                        </select>
                                    </div>
                                    <div class="product-preview" id="productPreview" style="position: relative; margin-top: 15px; border-radius: 8px; overflow: hidden; min-height: 200px; background: #f8f9fa; border: 1px solid #e0e0e0; padding: 20px; text-align: center;">
                                        <div style="color: #666; font-size: 16px;">
                                            <span style="font-size: 48px; display: block; margin-bottom: 10px;">📦</span>
                                            <p>Превью товара появится здесь после выбора</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer" style="display: flex !important; justify-content: center !important; gap: 15px !important; padding: 20px 30px 30px 30px !important; border-top: 1px solid #e0e0e0 !important;">
                                <button class="btn-secondary" onclick="closeContentModal()" style="padding: 12px 24px !important; border: 1px solid #000000 !important; border-radius: 5px !important; font-size: 16px !important; font-weight: 500 !important; cursor: pointer !important; background: #ffffff !important; color: #000000 !important;">Отмена</button>
                                <button class="btn-primary" onclick="saveProductContent('${page}', '${element}')" style="padding: 12px 24px !important; border: none !important; border-radius: 5px !important; font-size: 16px !important; font-weight: 500 !important; cursor: pointer !important; background: #000000 !important; color: #ffffff !important;">Сохранить изменения</button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (page === 'transitions') {
                // Специальное модальное окно для переходов
                modalHTML = `
                    <div class="content-modal" id="contentModal" style="position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important; background: rgba(0, 0, 0, 0.8) !important; display: flex !important; justify-content: center !important; align-items: center !important; z-index: 999999 !important;">
                        <div class="modal-content" style="background: white !important; border-radius: 10px !important; width: 90% !important; max-width: 600px !important; max-height: 85vh !important; overflow-y: auto !important; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3) !important; padding: 0 !important;">
                            <div class="modal-header" style="display: flex !important; justify-content: space-between !important; align-items: center !important; padding: 30px 30px 20px 30px !important; border-bottom: 1px solid #e0e0e0 !important;">
                                <h3 style="color: #000000 !important; margin: 0 !important; font-size: 24px !important; font-weight: bold !important;">Редактирование перехода</h3>
                                <button class="modal-close" onclick="closeContentModal()" style="background: none !important; border: none !important; color: #000000 !important; font-size: 28px !important; cursor: pointer !important; padding: 0 !important; width: 35px !important; height: 35px !important; display: flex !important; align-items: center !important; justify-content: center !important; border-radius: 50% !important;">×</button>
                            </div>
                            <div class="modal-body" style="padding: 30px !important;">
                                <div class="content-info" style="background: #f8f9fa; border: 1px solid #e0e0e0; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                                    <p style="color: #000000; font-size: 14px; margin: 5px 0;"><strong>Страница:</strong> ${getPageName(page)}</p>
                                    <p style="color: #000000; font-size: 14px; margin: 5px 0;"><strong>Элемент:</strong> ${getElementName(element)}</p>
                                </div>
                                <div class="content-form">
                                    <div class="form-group" style="margin-bottom: 20px;">
                                        <label style="color: #000000; font-weight: bold; display: block; margin-bottom: 10px;">1. ЗАГРУЗКА ФОТО:</label>
                                        <div class="image-upload-area" id="contentImageUploadArea" style="border: 2px dashed #e0e0e0; border-radius: 8px; padding: 30px; text-align: center; cursor: pointer; background: #f8f9fa; margin-bottom: 15px;">
                                            <input type="file" id="contentImageUpload" accept="image/*" style="display: none;">
                                            <div class="upload-placeholder" style="color: #000000;">
                                                <span class="upload-icon" style="font-size: 48px; display: block; margin-bottom: 10px;">📷</span>
                                                <p>Нажмите для загрузки изображения</p>
                                                <p style="font-size: 12px; color: #666; margin-top: 10px;">Рекомендуемый размер: ${getRecommendedImageSize(page, element)}</p>
                                            </div>
                                        </div>
                                        <div class="image-preview" id="contentImagePreview" style="position: relative; margin-top: 15px; border-radius: 8px; overflow: hidden; min-height: 100px; background: #f8f9fa; border: 1px solid #e0e0e0;"></div>
                                        <input type="hidden" id="contentImageUrl" name="contentImageUrl">
                                    </div>
                                    <div class="form-group" style="margin-bottom: 20px;">
                                        <label style="color: #000000; font-weight: bold; display: block; margin-bottom: 10px;">2. ОГЛАВЛЕНИЕ:</label>
                                        <input type="text" id="contentTitle" placeholder="Введите оглавление (например: TELEGRAM, VK MARKET, КИНОШЁП)" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 5px; font-size: 16px; background: #ffffff; color: #000000;">
                                    </div>
                                    <div class="form-group" style="margin-bottom: 20px;">
                                        <label style="color: #000000; font-weight: bold; display: block; margin-bottom: 10px;">3. ССЫЛКА ДЛЯ ПЕРЕХОДА:</label>
                                        <input type="url" id="contentLink" placeholder="Введите ссылку (например: https://t.me/example)" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 5px; font-size: 16px; background: #ffffff; color: #000000;">
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer" style="display: flex !important; justify-content: center !important; gap: 15px !important; padding: 20px 30px 30px 30px !important; border-top: 1px solid #e0e0e0 !important;">
                                <button class="btn-secondary" onclick="closeContentModal()" style="padding: 12px 24px !important; border: 1px solid #000000 !important; border-radius: 5px !important; font-size: 16px !important; font-weight: 500 !important; cursor: pointer !important; background: #ffffff !important; color: #000000 !important;">Отмена</button>
                                <button class="btn-primary" onclick="saveTransitionsContent('${page}', '${element}')" style="padding: 12px 24px !important; border: none !important; border-radius: 5px !important; font-size: 16px !important; font-weight: 500 !important; cursor: pointer !important; background: #000000 !important; color: #ffffff !important;">Сохранить изменения</button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Обычное модальное окно для остальных случаев
                modalHTML = `
                    <div class="content-modal" id="contentModal" style="position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important; background: rgba(0, 0, 0, 0.8) !important; display: flex !important; justify-content: center !important; align-items: center !important; z-index: 999999 !important;">
                        <div class="modal-content" style="background: white !important; border-radius: 10px !important; width: 90% !important; max-width: 600px !important; max-height: 85vh !important; overflow-y: auto !important; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3) !important; padding: 0 !important;">
                            <div class="modal-header" style="display: flex !important; justify-content: space-between !important; align-items: center !important; padding: 30px 30px 20px 30px !important; border-bottom: 1px solid #e0e0e0 !important;">
                                <h3 style="color: #000000 !important; margin: 0 !important; font-size: 24px !important; font-weight: bold !important;">Редактирование контента</h3>
                                <button class="modal-close" onclick="closeContentModal()" style="background: none !important; border: none !important; color: #000000 !important; font-size: 28px !important; cursor: pointer !important; padding: 0 !important; width: 35px !important; height: 35px !important; display: flex !important; align-items: center !important; justify-content: center !important; border-radius: 50% !important;">×</button>
                            </div>
                            <div class="modal-body" style="padding: 30px !important;">
                                <div class="content-info" style="background: #f8f9fa; border: 1px solid #e0e0e0; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                                    <p style="color: #000000; font-size: 14px; margin: 5px 0;"><strong>Страница:</strong> ${getPageName(page)}</p>
                                    <p style="color: #000000; font-size: 14px; margin: 5px 0;"><strong>Элемент:</strong> ${getElementName(element)}</p>
                                </div>
                                <div class="content-form">
                                    <div class="form-group" style="margin-bottom: 20px;">
                                        <label style="color: #000000; font-weight: bold; display: block; margin-bottom: 10px;">1. ЗАГРУЗКА ИЗОБРАЖЕНИЯ:</label>
                                        <div class="image-upload-area" id="contentImageUploadArea" style="border: 2px dashed #e0e0e0; border-radius: 8px; padding: 30px; text-align: center; cursor: pointer; background: #f8f9fa; margin-bottom: 15px;">
                                            <input type="file" id="contentImageUpload" accept="image/*" style="display: none;">
                                            <div class="upload-placeholder" style="color: #000000;">
                                                <span class="upload-icon" style="font-size: 48px; display: block; margin-bottom: 10px;">📷</span>
                                                <p>Нажмите для загрузки изображения</p>
                                                <p style="font-size: 12px; color: #666; margin-top: 10px;">Рекомендуемый размер: ${getRecommendedImageSize(page, element)}</p>
                                            </div>
                                        </div>
                                        <div class="image-preview" id="contentImagePreview" style="position: relative; margin-top: 15px; border-radius: 8px; overflow: hidden; min-height: 100px; background: #f8f9fa; border: 1px solid #e0e0e0;"></div>
                                        <input type="hidden" id="contentImageUrl" name="contentImageUrl">
                                    </div>
                                    ${showTextFields ? `
                                    <div class="form-group" style="margin-bottom: 20px;">
                                        <label style="color: #000000; font-weight: bold; display: block; margin-bottom: 10px;">2. ОГЛАВЛЕНИЕ:</label>
                                        <input type="text" id="contentTitle" placeholder="Введите оглавление" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 5px; font-size: 16px; background: #ffffff; color: #000000;">
                                    </div>
                                    <div class="form-group" style="margin-bottom: 20px;">
                                        <label style="color: #000000; font-weight: bold; display: block; margin-bottom: 10px;">3. ОПИСАНИЕ:</label>
                                        <textarea id="contentDescription" placeholder="Введите описание" rows="4" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 5px; font-size: 16px; background: #ffffff; color: #000000; resize: vertical; min-height: 100px;"></textarea>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="modal-footer" style="display: flex !important; justify-content: center !important; gap: 15px !important; padding: 20px 30px 30px 30px !important; border-top: 1px solid #e0e0e0 !important;">
                                <button class="btn-secondary" onclick="closeContentModal()" style="padding: 12px 24px !important; border: 1px solid #000000 !important; border-radius: 5px !important; font-size: 16px !important; font-weight: 500 !important; cursor: pointer !important; background: #ffffff !important; color: #000000 !important;">Отмена</button>
                                <button class="btn-primary" onclick="saveContent('${page}', '${element}')" style="padding: 12px 24px !important; border: none !important; border-radius: 5px !important; font-size: 16px !important; font-weight: 500 !important; cursor: pointer !important; background: #000000 !important; color: #ffffff !important;">Сохранить изменения</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Добавляем модальное окно на страницу
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Настраиваем загрузку изображения
            setupContentImageUpload();
            
            // Загружаем существующие данные
            loadContentData(page, element);
        }

        // Закрытие модального окна
        function closeContentModal() {
            const modal = document.getElementById('contentModal');
            if (modal) {
                modal.remove();
            }
        }

        // Получение названия страницы
        function getPageName(page) {
            const pageNames = {
                'main': 'Главная страница',
                'new-arrivals': 'Новые поступления',
                'catalog': 'Каталог',
                'about': 'О нас',
                'help': 'Помощь',
                'transitions': 'Переходы'
            };
            return pageNames[page] || page;
        }

        // Получение рекомендуемого размера изображения
        function getRecommendedImageSize(page, element) {
            // Баннеры на главной странице (полноэкранные)
            if (page === 'main' && (element === 'banner1' || element === 'banner2' || element === 'banner3')) {
                return '1920×1080px';
            }
            
            // Баннеры на странице "О нас" (половина экрана)
            if (page === 'about' && element === 'banner') {
                return '960×1080px';
            }
            
            // Баннеры на странице "Помощь" (половина экрана)
            if (page === 'help' && element === 'banner') {
                return '960×1080px';
            }
            
            // Баннер каталога
            if (page === 'catalog' && element === 'hero') {
                return '1920×1080px';
            }
            
            // Социальные блоки (переходы)
            if (page === 'transitions' && (element === 'block1' || element === 'block2' || element === 'block3')) {
                return '466×400px';
            }
            
            // Баннер 4 (нижний блок)
            if (page === 'main' && element === 'banner4') {
                return '1920×1080px';
            }
            
            // По умолчанию для остальных случаев
            return '1920×1080px';
        }

        // Получение названия элемента
        function getElementName(element) {
            const elementNames = {
                'banner1': 'Баннер 1',
                'banner2': 'Баннер 2',
                'banner3': 'Баннер 3',
                'banner4': 'Баннер 4 (Нижний)',
                'banner': 'Баннер',
                'hero': 'Баннер каталога',
                'block1': 'Блок 1',
                'block2': 'Блок 2',
                'block3': 'Блок 3',
                'product1': 'Товар 1',
                'product2': 'Товар 2',
                'product3': 'Товар 3',
                'product4': 'Товар 4'
            };
            return elementNames[element] || element;
        }

        // Загрузка списка товаров в выпадающий список
        function loadProductSelect() {
            const productSelect = document.getElementById('productSelect');
            if (!productSelect) return;

            // Обновляем список товаров перед загрузкой
            updateProductsForSelection();

            // Получаем список товаров из localStorage
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            console.log('Загружено товаров:', products.length);
            
            // Очищаем список
            productSelect.innerHTML = '<option value="">Выберите товар из списка</option>';
            
            // Добавляем товары в список
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name} (${product.price} ₽)`;
                productSelect.appendChild(option);
            });

            // Добавляем обработчик изменения
            productSelect.addEventListener('change', function() {
                const selectedProductId = this.value;
                console.log('Выбран товар ID:', selectedProductId);
                if (selectedProductId) {
                    showProductPreview(selectedProductId);
                } else {
                    clearProductPreview();
                }
            });
        }

        // Показать превью товара
        function showProductPreview(productId) {
            // Обновляем список товаров перед поиском
            updateProductsForSelection();
            
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            console.log('Ищем товар с ID:', productId, 'в списке из', products.length, 'товаров');
            
            // Преобразуем productId в число для корректного сравнения
            const numericId = parseInt(productId);
            const product = products.find(p => p.id === numericId);
            
            console.log('Найден товар:', product);
            
            const previewContainer = document.getElementById('productPreview');
            
            if (!product || !previewContainer) {
                console.error('Товар не найден или контейнер не найден');
                return;
            }

            // Используем первое изображение или заглушку
            const imageUrl = product.images && product.images.length > 0 && product.images[0] ? product.images[0] : 'placeholder.jpg';
            
            previewContainer.innerHTML = `
                <div style="background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <img src="${imageUrl}" alt="${product.name}" style="width: 100%; max-width: 200px; height: 150px; object-fit: cover; border-radius: 8px; border: 1px solid #e0e0e0;">
                    </div>
                    <h4 style="color: #000; font-size: 18px; font-weight: bold; margin: 0 0 10px 0; text-align: center;">${product.name}</h4>
                    <p style="color: #e74c3c; font-size: 20px; font-weight: bold; text-align: center; margin: 0;">${product.price.toLocaleString()} ₽</p>
                </div>
            `;
        }

        // Очистить превью товара
        function clearProductPreview() {
            const previewContainer = document.getElementById('productPreview');
            if (previewContainer) {
                previewContainer.innerHTML = `
                    <div style="color: #666; font-size: 16px;">
                        <span style="font-size: 48px; display: block; margin-bottom: 10px;">📦</span>
                        <p>Превью товара появится здесь после выбора</p>
                    </div>
                `;
            }
        }

        // Сохранение выбранного товара
        function saveProductContent(page, element) {
            const productSelect = document.getElementById('productSelect');
            const selectedProductId = productSelect ? productSelect.value : '';
            
            if (!selectedProductId) {
                alert('Пожалуйста, выберите товар');
                return;
            }

            // Получаем данные о товаре
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            console.log('Ищем товар для сохранения, ID:', selectedProductId);
            console.log('Доступные товары:', products.length);
            
            // Преобразуем productId в число для корректного сравнения
            const numericId = parseInt(selectedProductId);
            const selectedProduct = products.find(p => p.id === numericId);
            
            console.log('Найден товар для сохранения:', selectedProduct);
            
            if (!selectedProduct) {
                console.error('Товар не найден в списке');
                alert('Товар не найден');
                return;
            }

            // ПРОСТОЕ СОХРАНЕНИЕ - только ID товара в pageContent
            const pageContent = JSON.parse(localStorage.getItem('pageContent') || '{}');
            if (!pageContent.newArrivals) {
                pageContent.newArrivals = {};
            }
            pageContent.newArrivals[element] = selectedProductId;
            localStorage.setItem('pageContent', JSON.stringify(pageContent));
            
            console.log(`✅ Сохранен товар ${selectedProductId} для ${element}`);
            console.log('📊 Обновленный pageContent:', pageContent);
            
            // Закрываем модальное окно
            closeContentModal();
            
            // Показываем уведомление
            showNotification('Товар успешно сохранен!', 'success');
        }

        // Загрузка данных о выбранном товаре
        function loadProductData(page, element) {
            const pageContent = JSON.parse(localStorage.getItem('pageContent') || '{}');
            const newArrivals = pageContent.newArrivals || {};
            const productId = newArrivals[element];
            
            console.log('Загружаем данные товара для', element, ':', productId);
            
            if (productId) {
                const productSelect = document.getElementById('productSelect');
                if (productSelect) {
                    productSelect.value = productId;
                    showProductPreview(productId);
                }
            }
        }

        // Обновление списка товаров для выбора в модальных окнах
        function updateProductsForSelection() {
            // Получаем все товары из localStorage
            const products = [];
            const productIds = JSON.parse(localStorage.getItem('productIds') || '[]');
            
            productIds.forEach(id => {
                const productData = localStorage.getItem(`product_${id}`);
                if (productData) {
                    try {
                        products.push(JSON.parse(productData));
                    } catch (error) {
                        console.error('Ошибка при парсинге товара:', error);
                    }
                }
            });
            
            // Сохраняем обновленный список товаров
            localStorage.setItem('products', JSON.stringify(products));
            console.log('Обновлен список товаров для выбора:', products.length, 'товаров');
        }

        // Настройка загрузки изображения для контента
        function setupContentImageUpload() {
            const imageUploadArea = document.getElementById('contentImageUploadArea');
            const imageUpload = document.getElementById('contentImageUpload');

            if (imageUploadArea && imageUpload) {
                imageUploadArea.addEventListener('click', () => imageUpload.click());
                
                imageUpload.addEventListener('change', (e) => {
                    handleContentImage(e.target.files[0]);
                });
            }
        }

        // Обработка изображения для контента
        // Функция для конвертации файла в base64 без сжатия
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function() {
                    resolve(reader.result);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function handleContentImage(file) {
            if (file && file.type.startsWith('image/')) {
                try {
                    // Сжимаем изображение с высоким качеством для баннеров
                    const compressedImageUrl = await compressImage(file, 1920, 0.9);
                    
                    // Создаем уникальное имя файла
                    const timestamp = Date.now();
                    const fileName = `content_${timestamp}_${file.name}`;
                    const filePath = `images/${fileName}`;
                    
                    // Сохраняем информацию о файле
                    const imageInfo = {
                        path: filePath,
                        name: fileName,
                        size: file.size,
                        type: file.type,
                        timestamp: timestamp,
                        compressedSize: compressedImageUrl.length
                    };
                    localStorage.setItem(`content_image_${timestamp}`, JSON.stringify(imageInfo));
                    
                    // Показываем превью
                    const previewContainer = document.getElementById('contentImagePreview');
                    previewContainer.innerHTML = `
                        <img src="${compressedImageUrl}" alt="Content Preview" style="width: 100%; height: 100%; object-fit: cover;">
                        <button type="button" class="remove-image" onclick="removeContentImage()">×</button>
                    `;
                    
                    // Сохраняем URL изображения в скрытое поле
                    const hiddenImageInput = document.getElementById('contentImageUrl');
                    if (hiddenImageInput) {
                        hiddenImageInput.value = compressedImageUrl;
                        console.log('✅ Скрытое поле обновлено:', hiddenImageInput.id, 'значение:', compressedImageUrl.substring(0, 50) + '...');
                    } else {
                        console.error('❌ Скрытое поле contentImageUrl не найдено!');
                    }
                    
                    console.log(`✅ Изображение контента сжато: ${(file.size/1024/1024).toFixed(2)}MB → ${(compressedImageUrl.length*0.75/1024/1024).toFixed(2)}MB`);
                } catch (error) {
                    console.error('Ошибка при обработке изображения контента:', error);
                    alert('Ошибка при обработке изображения: ' + error.message);
                }
            }
        }

        // Удаление изображения контента
        function removeContentImage() {
            const previewContainer = document.getElementById('contentImagePreview');
            if (previewContainer) {
                previewContainer.innerHTML = '';
            }
            
            const hiddenImageInput = document.getElementById('contentImageUrl');
            if (hiddenImageInput) {
                hiddenImageInput.value = '';
                console.log('✅ Скрытое поле очищено');
            } else {
                console.error('❌ Скрытое поле contentImageUrl не найдено при удалении!');
            }
        }

        // Загрузка данных контента
        function loadContentData(page, element) {
            // Проверяем, является ли это товаром в новых поступлениях
            const isNewArrivalsProduct = page === 'new-arrivals' && element.startsWith('product');
            
            if (isNewArrivalsProduct) {
                // Загружаем данные для товаров
                loadProductSelect();
                loadProductData(page, element);
                return;
            }
            
            // Проверяем, является ли это переходом
            if (page === 'transitions') {
                // Загружаем данные для переходов
                loadTransitionsData(page, element);
                return;
            }
            
            // Получаем данные из pageContent для остальных случаев
            const pageContent = JSON.parse(localStorage.getItem('pageContent') || '{}');
            const contentData = pageContent[page] ? pageContent[page][element] || {} : {};
            
            console.log(`Загружаем данные для ${page}.${element}:`, contentData);
            
            // Загружаем заголовок и описание только если поля существуют (не для about и help)
            const titleElement = document.getElementById('contentTitle');
            const descriptionElement = document.getElementById('contentDescription');
            
            if (titleElement) {
                titleElement.value = contentData.title || '';
            }
            if (descriptionElement) {
                descriptionElement.value = contentData.description || '';
            }
            
            // Загружаем изображение если есть
            if (contentData.image) {
                const previewContainer = document.getElementById('contentImagePreview');
                previewContainer.innerHTML = `
                    <img src="${contentData.image}" alt="Content Preview" style="width: 100%; height: 100%; object-fit: cover;">
                    <button type="button" class="remove-image" onclick="removeContentImage()">×</button>
                `;
                
                // Создаем скрытое поле для URL изображения
                let hiddenImageInput = document.getElementById('contentImageUrl');
                if (!hiddenImageInput) {
                    hiddenImageInput = document.createElement('input');
                    hiddenImageInput.type = 'hidden';
                    hiddenImageInput.id = 'contentImageUrl';
                    document.getElementById('contentModal').appendChild(hiddenImageInput);
                }
                hiddenImageInput.value = contentData.image;
            } else {
                // Очищаем превью если изображения нет
                const previewContainer = document.getElementById('contentImagePreview');
                previewContainer.innerHTML = '';
                
                // Удаляем скрытое поле если есть
                const existingInput = document.getElementById('contentImageUrl');
                if (existingInput) {
                    existingInput.remove();
                }
            }
        }

        // Загрузка данных переходов
        function loadTransitionsData(page, element) {
            const pageContent = JSON.parse(localStorage.getItem('pageContent') || '{}');
            const contentData = pageContent[page] ? pageContent[page][element] || {} : {};
            
            console.log(`Загружаем данные переходов для ${page}.${element}:`, contentData);
            
            // Загружаем заголовок
            const titleElement = document.getElementById('contentTitle');
            if (titleElement) {
                titleElement.value = contentData.title || '';
            }
            
            // Загружаем ссылку
            const linkElement = document.getElementById('contentLink');
            if (linkElement) {
                linkElement.value = contentData.link || '';
            }
            
            // Загружаем изображение если есть
            if (contentData.image) {
                const previewContainer = document.getElementById('contentImagePreview');
                previewContainer.innerHTML = `
                    <img src="${contentData.image}" alt="Content Preview" style="width: 100%; height: 100%; object-fit: cover;">
                    <button type="button" class="remove-image" onclick="removeContentImage()">×</button>
                `;
                
                // Создаем скрытое поле для URL изображения
                let hiddenImageInput = document.getElementById('contentImageUrl');
                if (!hiddenImageInput) {
                    hiddenImageInput = document.createElement('input');
                    hiddenImageInput.type = 'hidden';
                    hiddenImageInput.id = 'contentImageUrl';
                    document.getElementById('contentModal').appendChild(hiddenImageInput);
                }
                hiddenImageInput.value = contentData.image;
            } else {
                // Очищаем превью если изображения нет
                const previewContainer = document.getElementById('contentImagePreview');
                previewContainer.innerHTML = '';
                
                // Удаляем скрытое поле если есть
                const existingInput = document.getElementById('contentImageUrl');
                if (existingInput) {
                    existingInput.remove();
                }
            }
        }

        // Сохранение контента
        function saveContent(page, element) {
            console.log('🚀 Функция saveContent вызвана!');
            console.log('Параметры:', page, element);
            
            try {
                // Проверяем, есть ли поля заголовка и описания (для страниц about и help их нет)
                const titleElement = document.getElementById('contentTitle');
                const descriptionElement = document.getElementById('contentDescription');
                const title = titleElement ? titleElement.value : '';
                const description = descriptionElement ? descriptionElement.value : '';
                const imageInput = document.getElementById('contentImageUrl');
                const image = imageInput ? imageInput.value : '';
                
                console.log('🔍 Отладка сохранения:');
                console.log('- Страница:', page);
                console.log('- Элемент:', element);
                console.log('- Заголовок:', title);
                console.log('- Описание:', description);
                console.log('- Элемент изображения найден:', !!imageInput);
                console.log('- ID элемента изображения:', imageInput ? imageInput.id : 'не найден');
                console.log('- URL изображения:', image ? image.substring(0, 50) + '...' : 'пусто');
                console.log('- Длина URL изображения:', image ? image.length : 0);
            
            // Определяем номер баннера на основе элемента
            let number = '';
            if (element === 'banner1') number = '001';
            else if (element === 'banner2') number = '002';
            else if (element === 'banner3') number = '003';
            else if (element === 'banner4') number = '004';
            else if (element === 'hero') number = '001'; // Для каталога
            else number = '001'; // По умолчанию
            
            const contentData = {
                number: number,
                title: title,
                description: description,
                image: image,
                lastUpdated: new Date().toISOString()
            };

            // Получаем существующие данные pageContent
            const pageContent = JSON.parse(localStorage.getItem('pageContent') || '{}');
            
            // Инициализируем структуру для страницы, если её нет
            if (!pageContent[page]) {
                pageContent[page] = {};
            }
            
            // Сохраняем данные элемента
            pageContent[page][element] = contentData;
            
            // Проверяем размер данных перед сохранением
            const pageContentString = JSON.stringify(pageContent);
            const dataSizeMB = (pageContentString.length * 2) / 1024 / 1024; // Примерный размер в MB
            
            console.log(`📊 Размер данных для сохранения: ${dataSizeMB.toFixed(2)}MB`);
            
            if (dataSizeMB > 5) {
                console.warn('⚠️ Внимание: Размер данных превышает 5MB!');
            }
            
            // Сохраняем обратно в localStorage
            try {
                localStorage.setItem('pageContent', pageContentString);
                console.log(`✅ Контент сохранен: ${page}.${element}`, contentData);
                console.log('✅ Обновленный pageContent:', pageContent);
            } catch (storageError) {
                console.error('❌ Ошибка сохранения в localStorage:', storageError);
                throw new Error('Не удалось сохранить данные. Возможно, превышен лимит хранилища.');
            }
            
            // Показываем уведомление
            showNotification('Контент успешно сохранен!', 'success');
            
            // Закрываем модальное окно
            closeContentModal();
            
            } catch (error) {
                console.error('❌ Ошибка при сохранении контента:', error);
                alert('Ошибка при сохранении: ' + error.message);
            }
        }

        // Сохранение контента переходов
        function saveTransitionsContent(page, element) {
            console.log('🚀 Функция saveTransitionsContent вызвана!');
            console.log('Параметры:', page, element);
            
            try {
                const titleElement = document.getElementById('contentTitle');
                const linkElement = document.getElementById('contentLink');
                const imageInput = document.getElementById('contentImageUrl');
                
                const title = titleElement ? titleElement.value : '';
                const link = linkElement ? linkElement.value : '';
                const image = imageInput ? imageInput.value : '';
                
                console.log('🔍 Отладка сохранения переходов:');
                console.log('- Заголовок:', title);
                console.log('- Ссылка:', link);
                console.log('- Изображение найдено:', !!imageInput);
                console.log('- URL изображения:', image ? image.substring(0, 50) + '...' : 'пусто');
            
            // Определяем номер блока на основе элемента
            let number = '';
            if (element === 'block1') number = '15';
            else if (element === 'block2') number = '16';
            else if (element === 'block3') number = '17';
            else number = '15'; // По умолчанию
            
            const contentData = {
                number: number,
                title: title,
                link: link,
                image: image,
                lastUpdated: new Date().toISOString()
            };

            // Получаем существующие данные pageContent
            const pageContent = JSON.parse(localStorage.getItem('pageContent') || '{}');
            
            // Инициализируем структуру для страницы, если её нет
            if (!pageContent[page]) {
                pageContent[page] = {};
            }
            
            // Сохраняем данные элемента
            pageContent[page][element] = contentData;
            
            // Проверяем размер данных перед сохранением
            const pageContentString = JSON.stringify(pageContent);
            const dataSizeMB = (pageContentString.length * 2) / 1024 / 1024; // Примерный размер в MB
            
            console.log(`📊 Размер данных для сохранения: ${dataSizeMB.toFixed(2)}MB`);
            
            if (dataSizeMB > 5) {
                console.warn('⚠️ Внимание: Размер данных превышает 5MB!');
            }
            
            // Сохраняем обратно в localStorage
            try {
                localStorage.setItem('pageContent', pageContentString);
                console.log(`✅ Контент переходов сохранен: ${page}.${element}`, contentData);
                console.log('✅ Обновленный pageContent:', pageContent);
            } catch (storageError) {
                console.error('❌ Ошибка сохранения в localStorage:', storageError);
                throw new Error('Не удалось сохранить данные. Возможно, превышен лимит хранилища.');
            }
            
            // Показываем уведомление
            showNotification('Контент переходов успешно сохранен!', 'success');
            
            // Закрываем модальное окно
            closeContentModal();
            
            } catch (error) {
                console.error('❌ Ошибка при сохранении контента переходов:', error);
                alert('Ошибка при сохранении: ' + error.message);
            }
        }

        // Показ уведомления
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 6px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Фильтрация контента
        function filterContent(filter) {
            console.log(`Фильтрация контента: ${filter}`);
            
            // Скрываем все секции контента
            const contentSections = [
                'mainContent',
                'new-arrivalsContent',
                'catalogContent', 
                'aboutContent',
                'helpContent',
                'transitionsContent'
            ];
            
            contentSections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.style.display = 'none';
                }
            });
            
            // Показываем нужную секцию
            const targetSection = document.getElementById(`${filter}Content`);
            if (targetSection) {
                targetSection.style.display = 'block';
            }
            
            // Обновляем активную кнопку фильтра
            document.querySelectorAll('.content-filters .filter-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = '#2a2a2a !important';
                btn.style.border = '2px solid #444 !important';
            });
            
            const activeBtn = document.querySelector(`[data-filter="${filter}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.style.background = '#000000 !important';
                activeBtn.style.border = '2px solid #ffffff !important';
            }
        }

        // ===== ФУНКЦИИ ДЛЯ ПРОМОКОДОВ =====

        // Инициализация системы промокодов
        function initPromocodes() {
            console.log('Инициализация системы промокодов...');
            loadPromocodes();
        }

        // Загрузка промокодов
        function loadPromocodes() {
            const promocodes = JSON.parse(localStorage.getItem('promocodes') || '[]');
            renderPromocodesTable(promocodes);
        }

        // Отображение таблицы промокодов
        function renderPromocodesTable(promocodes) {
            const tbody = document.getElementById('promocodesTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            promocodes.forEach(promocode => {
                const row = document.createElement('tr');
                const isExpired = new Date(promocode.endDate) < new Date();
                const statusClass = isExpired ? 'status-expired' : 'status-active';
                const statusText = isExpired ? 'Истек' : 'Активен';
                const discountText = promocode.type === 'percentage' ? `${promocode.value}%` : `${promocode.value} ₽`;

                row.innerHTML = `
                    <td><strong>${promocode.code}</strong></td>
                    <td>${promocode.type === 'percentage' ? 'Процент' : 'Рубли'}</td>
                    <td>${discountText}</td>
                    <td>${formatDate(promocode.startDate)}</td>
                    <td>${formatDate(promocode.endDate)}</td>
                    <td>${promocode.usageCount || 0}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>
                        <button class="action-btn delete" onclick="deletePromocode('${promocode.id}')">🗑️</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Фильтрация промокодов
        function filterPromocodes(filter) {
            const promocodes = JSON.parse(localStorage.getItem('promocodes') || '[]');
            let filteredPromocodes = promocodes;

            if (filter === 'active') {
                filteredPromocodes = promocodes.filter(p => new Date(p.endDate) >= new Date());
            } else if (filter === 'expired') {
                filteredPromocodes = promocodes.filter(p => new Date(p.endDate) < new Date());
            }

            renderPromocodesTable(filteredPromocodes);

            // Обновляем активную кнопку
            document.querySelectorAll('.promocodes-filters .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Открытие модального окна для промокода
        function openPromocodeModal(promocodeId = null) {
            const isEdit = promocodeId !== null;
            const promocode = isEdit ? JSON.parse(localStorage.getItem('promocodes') || '[]').find(p => p.id === promocodeId) : null;

            const modalHTML = `
                <div class="modal" id="promocodeModal" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center; z-index: 9999;">
                    <div class="modal-content" style="background: white; border-radius: 10px; width: 90%; max-width: 500px; padding: 30px;">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: #000;">${isEdit ? 'Редактировать промокод' : 'Добавить промокод'}</h3>
                            <button onclick="closePromocodeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">×</button>
                        </div>
                        <form id="promocodeForm">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #000;">Код промокода:</label>
                                <input type="text" id="promocodeCode" value="${promocode ? promocode.code : ''}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; text-transform: uppercase;" placeholder="Введите код промокода">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #000;">Тип скидки:</label>
                                <select id="promocodeType" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                    <option value="percentage" ${promocode && promocode.type === 'percentage' ? 'selected' : ''}>Процент (%)</option>
                                    <option value="fixed" ${promocode && promocode.type === 'fixed' ? 'selected' : ''}>Рубли (₽)</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #000;">Количество скидки:</label>
                                <input type="number" id="promocodeValue" value="${promocode ? promocode.value : ''}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="Введите количество">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #000;">Дата начала действия:</label>
                                <input type="datetime-local" id="promocodeStartDate" value="${promocode ? promocode.startDate.slice(0, 16) : ''}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #000;">Дата окончания действия:</label>
                                <input type="datetime-local" id="promocodeEndDate" value="${promocode ? promocode.endDate.slice(0, 16) : ''}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px;">
                                <button type="button" onclick="closePromocodeModal()" style="padding: 12px 24px; border: 1px solid #ddd; background: white; border-radius: 5px; cursor: pointer; font-weight: bold;">ОТМЕНА</button>
                                <button type="submit" style="padding: 12px 24px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">СОХРАНИТЬ ПРОМОКОД</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Обработчик формы
            document.getElementById('promocodeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                savePromocode(promocodeId);
            });

            // Автоматическое преобразование кода в большие буквы
            const codeInput = document.getElementById('promocodeCode');
            if (codeInput) {
                codeInput.addEventListener('input', function() {
                    this.value = this.value.toUpperCase();
                });
            }
        }

        // Сохранение промокода
        function savePromocode(promocodeId = null) {
            const isEdit = promocodeId !== null;
            const promocodes = JSON.parse(localStorage.getItem('promocodes') || '[]');

            const promocodeData = {
                id: isEdit ? promocodeId : Date.now().toString(),
                code: document.getElementById('promocodeCode').value.toUpperCase(),
                type: document.getElementById('promocodeType').value,
                value: parseFloat(document.getElementById('promocodeValue').value),
                startDate: document.getElementById('promocodeStartDate').value,
                endDate: document.getElementById('promocodeEndDate').value,
                usageCount: isEdit ? promocodes.find(p => p.id === promocodeId)?.usageCount || 0 : 0,
                createdAt: isEdit ? promocodes.find(p => p.id === promocodeId)?.createdAt : new Date().toISOString()
            };

            if (isEdit) {
                const index = promocodes.findIndex(p => p.id === promocodeId);
                promocodes[index] = promocodeData;
            } else {
                promocodes.push(promocodeData);
            }

            localStorage.setItem('promocodes', JSON.stringify(promocodes));
            closePromocodeModal();
            loadPromocodes();
            showNotification(isEdit ? 'Промокод обновлен!' : 'Промокод добавлен!', 'success');
        }

        // Редактирование промокода
        function editPromocode(promocodeId) {
            openPromocodeModal(promocodeId);
        }

        // Удаление промокода
        function deletePromocode(promocodeId) {
            if (confirm('Вы уверены, что хотите удалить этот промокод?')) {
                const promocodes = JSON.parse(localStorage.getItem('promocodes') || '[]');
                const filteredPromocodes = promocodes.filter(p => p.id !== promocodeId);
                localStorage.setItem('promocodes', JSON.stringify(filteredPromocodes));
                loadPromocodes();
                showNotification('Промокод удален!', 'success');
            }
        }

        // Закрытие модального окна промокода
        function closePromocodeModal() {
            const modal = document.getElementById('promocodeModal');
            if (modal) modal.remove();
        }

        // Создание тестового промокода для проверки
        function createTestPromocode() {
            const testPromocode = {
                id: Date.now().toString(),
                code: 'TEST10',
                type: 'percentage',
                value: 10,
                startDate: new Date().toISOString().slice(0, 16),
                endDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().slice(0, 16),
                usageCount: 0,
                createdAt: new Date().toISOString()
            };

            const promocodes = JSON.parse(localStorage.getItem('promocodes') || '[]');
            promocodes.push(testPromocode);
            localStorage.setItem('promocodes', JSON.stringify(promocodes));
            loadPromocodes();
            showNotification('Тестовый промокод TEST10 создан!', 'success');
        }

        // ===== ФУНКЦИИ ДЛЯ СКИДОК =====

        // Инициализация системы скидок
        function initDiscounts() {
            console.log('Инициализация системы скидок...');
            loadDiscounts();
        }

        // Загрузка скидок
        function loadDiscounts() {
            const discounts = JSON.parse(localStorage.getItem('discounts') || '[]');
            renderDiscountsTable(discounts);
        }

        // Отображение таблицы скидок
        function renderDiscountsTable(discounts) {
            const tbody = document.getElementById('discountsTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            discounts.forEach(discount => {
                const row = document.createElement('tr');
                const isExpired = new Date(discount.endDate) < new Date();
                const statusClass = isExpired ? 'status-expired' : 'status-active';
                const statusText = isExpired ? 'Истекла' : 'Активна';

                // Получаем название товара
                let productName = 'Товар не найден';
                try {
                    const product = JSON.parse(localStorage.getItem(`product_${discount.productId}`));
                    if (product && product.name) {
                        productName = product.name;
                    }
                } catch (e) {
                    console.error('Ошибка при загрузке товара:', e);
                }

                const discountText = discount.type === 'percentage' ? `${discount.value}%` : `${discount.value} ₽`;

                row.innerHTML = `
                    <td><strong>${productName}</strong></td>
                    <td>${discount.type === 'percentage' ? 'Процент' : 'Рубли'}</td>
                    <td>${discountText}</td>
                    <td>${formatDate(discount.startDate)}</td>
                    <td>${formatDate(discount.endDate)}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>
                        <button class="action-btn delete" onclick="deleteDiscount('${discount.id}')">🗑️</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Фильтрация скидок
        function filterDiscounts(filter) {
            const discounts = JSON.parse(localStorage.getItem('discounts') || '[]');
            let filteredDiscounts = discounts;

            if (filter === 'active') {
                filteredDiscounts = discounts.filter(d => new Date(d.endDate) >= new Date());
            } else if (filter === 'expired') {
                filteredDiscounts = discounts.filter(d => new Date(d.endDate) < new Date());
            }

            renderDiscountsTable(filteredDiscounts);

            // Обновляем активную кнопку
            document.querySelectorAll('.discounts-filters .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Открытие модального окна для скидки
        function openDiscountModal(discountId = null) {
            const isEdit = discountId !== null;
            const discount = isEdit ? JSON.parse(localStorage.getItem('discounts') || '[]').find(d => d.id === discountId) : null;

            // Загружаем список товаров для выпадающего списка
            const products = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('product_')) {
                    try {
                        const product = JSON.parse(localStorage.getItem(key));
                        if (product && product.id && product.name) {
                            products.push(product);
                        }
                    } catch (e) {
                        console.error('Ошибка при загрузке товара:', e);
                    }
                }
            }

            const productOptions = products.map(product => 
                `<option value="${product.id}" ${discount && discount.productId === product.id ? 'selected' : ''}>
                    ${product.name} (ID: ${product.id})
                </option>`
            ).join('');

            const modalHTML = `
                <div class="modal" id="discountModal" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center; z-index: 9999;">
                    <div class="modal-content" style="background: white; border-radius: 10px; width: 90%; max-width: 500px; padding: 30px;">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: #000;">${isEdit ? 'Редактировать скидку' : 'Добавить скидку'}</h3>
                            <button onclick="closeDiscountModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">×</button>
                        </div>
                        <form id="discountForm">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #000;">Выберите товар:</label>
                                <select id="discountProductId" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                    <option value="">Выберите товар для скидки</option>
                                    ${productOptions}
                                </select>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #000;">Тип скидки:</label>
                                <select id="discountType" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                    <option value="percentage" ${discount && discount.type === 'percentage' ? 'selected' : ''}>Процент (%)</option>
                                    <option value="fixed" ${discount && discount.type === 'fixed' ? 'selected' : ''}>Рубли (₽)</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #000;">Количество скидки:</label>
                                <input type="number" id="discountValue" value="${discount ? discount.value : ''}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="Введите количество">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #000;">Дата начала действия:</label>
                                <input type="datetime-local" id="discountStartDate" value="${discount ? discount.startDate.slice(0, 16) : ''}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; color: #000;">Дата окончания действия:</label>
                                <input type="datetime-local" id="discountEndDate" value="${discount ? discount.endDate.slice(0, 16) : ''}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px;">
                                <button type="button" onclick="closeDiscountModal()" style="padding: 12px 24px; border: 1px solid #ddd; background: white; border-radius: 5px; cursor: pointer; font-weight: bold;">ОТМЕНА</button>
                                <button type="submit" style="padding: 12px 24px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">СОХРАНИТЬ СКИДКУ</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Обработчик формы
            document.getElementById('discountForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveDiscount(discountId);
            });
        }

        // Сохранение скидки
        function saveDiscount(discountId = null) {
            const isEdit = discountId !== null;
            const discounts = JSON.parse(localStorage.getItem('discounts') || '[]');

            const discountData = {
                id: isEdit ? discountId : Date.now().toString(),
                productId: document.getElementById('discountProductId').value,
                type: document.getElementById('discountType').value,
                value: parseFloat(document.getElementById('discountValue').value),
                startDate: document.getElementById('discountStartDate').value,
                endDate: document.getElementById('discountEndDate').value,
                createdAt: isEdit ? discounts.find(d => d.id === discountId)?.createdAt : new Date().toISOString()
            };

            if (isEdit) {
                const index = discounts.findIndex(d => d.id === discountId);
                discounts[index] = discountData;
            } else {
                discounts.push(discountData);
            }

            localStorage.setItem('discounts', JSON.stringify(discounts));
            closeDiscountModal();
            loadDiscounts();
            showNotification(isEdit ? 'Скидка обновлена!' : 'Скидка добавлена!', 'success');
        }

        // Редактирование скидки
        function editDiscount(discountId) {
            openDiscountModal(discountId);
        }

        // Удаление скидки
        function deleteDiscount(discountId) {
            if (confirm('Вы уверены, что хотите удалить эту скидку?')) {
                const discounts = JSON.parse(localStorage.getItem('discounts') || '[]');
                const filteredDiscounts = discounts.filter(d => d.id !== discountId);
                localStorage.setItem('discounts', JSON.stringify(filteredDiscounts));
                loadDiscounts();
                showNotification('Скидка удалена!', 'success');
            }
        }

        // Закрытие модального окна скидки
        function closeDiscountModal() {
            const modal = document.getElementById('discountModal');
            if (modal) modal.remove();
        }

        // Создание тестовой скидки для проверки
        function createTestDiscount() {
            // Находим первый товар для создания скидки
            let firstProduct = null;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('product_')) {
                    try {
                        const product = JSON.parse(localStorage.getItem(key));
                        if (product && product.id && product.name) {
                            firstProduct = product;
                            break;
                        }
                    } catch (e) {
                        console.error('Ошибка при загрузке товара:', e);
                    }
                }
            }

            if (!firstProduct) {
                showNotification('Нет товаров для создания скидки!', 'error');
                return;
            }

            const testDiscount = {
                id: Date.now().toString(),
                productId: firstProduct.id.toString(),
                type: 'percentage',
                value: 15,
                startDate: new Date().toISOString().slice(0, 16),
                endDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().slice(0, 16),
                createdAt: new Date().toISOString()
            };

            const discounts = JSON.parse(localStorage.getItem('discounts') || '[]');
            discounts.push(testDiscount);
            localStorage.setItem('discounts', JSON.stringify(discounts));
            loadDiscounts();
            showNotification(`Тестовая скидка 15% создана для товара "${firstProduct.name}"!`, 'success');
        }

        // Вспомогательная функция для форматирования даты
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('ru-RU', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

    </script>
    <script src="js/supabase-store.js"></script>

    <form id="loginForm">
      <input type="email" id="email" placeholder="email" required>
      <input type="password" id="password" placeholder="пароль" required>
      <button>Войти</button>
    </form>
    <button id="logoutBtn" style="display:none">Выйти</button>

    <input type="text"   id="name"  placeholder="Название">
    <input type="number" id="price" placeholder="Цена">
    <input type="file"   id="files" accept="image/*" multiple>
    <button id="saveBtn">Сохранить товар</button>

    <script>
    const $ = (id) => document.getElementById(id);

    async function refreshAuthUI() {
      const u = await Store.currentUser();
      $('loginForm').style.display = u ? 'none' : '';
      $('logoutBtn').style.display = u ? '' : 'none';
    }
    $('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try { await Store.login($('email').value, $('password').value); await refreshAuthUI(); alert('Вошёл'); }
      catch(err){ alert(err.message); }
    });
    $('logoutBtn').addEventListener('click', async () => { await Store.logout(); await refreshAuthUI(); });

    $('saveBtn').addEventListener('click', async () => {
      try {
        const files = $('files').files;
        const urls  = files.length ? await Store.uploadImages(files) : [];
        const product = {
          name:  $('name').value || 'Без имени',
          price: Number($('price').value || 0),
          images: urls.length ? urls : [Store.PLACEHOLDER]
        };
        const id = await Store.saveProduct(product);
        alert('Товар сохранён, id=' + id);
      } catch (e) { alert('Ошибка: ' + e.message); }
    });

    document.addEventListener('DOMContentLoaded', refreshAuthUI);
    </script>
</body>
</html> 